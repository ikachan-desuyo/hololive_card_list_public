<!DOCTYPE html>
<html lang="ja">
<!-- Version: 4.1.0-COLLECTION-BINDER - Visual collection binder interface -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒ€ãƒ¼</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    .dark { 
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: #eee; 
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 10px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 2px solid rgba(102, 126, 234, 0.3);
    }

    .dark .header {
      background: rgba(44, 62, 80, 0.95);
      border-bottom-color: rgba(52, 152, 219, 0.3);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }

    .header h1 {
      margin: 0;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.8em;
      font-weight: bold;
    }

    /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    .compact-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .compact-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 20px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .compact-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .compact-btn.active {
      background: linear-gradient(45deg, #28a745, #20c997);
    }

    /* ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¡ã‚¤ãƒ³é ˜åŸŸ */
    .binder-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
    .binder-page {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .dark .binder-page {
      background: rgba(52, 73, 94, 0.95);
      border-color: rgba(255,255,255,0.1);
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
      padding-bottom: 10px;
    }

    .page-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #667eea;
    }

    .dark .page-title {
      color: #3498db;
    }

    .page-info {
      font-size: 0.9em;
      color: #666;
      display: flex;
      gap: 15px;
    }

    .dark .page-info {
      color: #bdc3c7;
    }

    /* ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ - 3x3ã®9æšé…ç½® */
    .binder-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 20px;
      margin: 20px 0;
    }

    /* ã‚«ãƒ¼ãƒ‰ã‚¹ãƒ­ãƒƒãƒˆ */
    .card-slot {
      aspect-ratio: 63/88;
      border: 3px dashed rgba(102, 126, 234, 0.3);
      border-radius: 12px;
      position: relative;
      transition: all 0.3s ease;
      background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(0,0,0,0.05));
      cursor: pointer;
      overflow: hidden;
    }

    .card-slot:hover {
      border-color: rgba(102, 126, 234, 0.8);
      transform: scale(1.02);
      box-shadow: 0 8px 25px rgba(102, 126, 234, 0.2);
    }

    .card-slot.occupied {
      border: 3px solid rgba(40, 167, 69, 0.8);
      background: linear-gradient(145deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
    }

    .card-slot.reserved {
      border: 3px solid rgba(255, 193, 7, 0.8);
      background: linear-gradient(145deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
    }

    /* ã‚«ãƒ¼ãƒ‰ç”»åƒ */
    .card-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s ease;
    }

    .card-slot:hover .card-image {
      transform: scale(1.05);
    }

    /* ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .card-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: white;
      padding: 8px;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }

    .card-slot:hover .card-overlay {
      transform: translateY(0);
    }

    .card-name {
      font-size: 0.8em;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .card-rarity {
      font-size: 0.7em;
      opacity: 0.9;
    }

    /* ç©ºãã‚¹ãƒ­ãƒƒãƒˆã®è¡¨ç¤º */
    .empty-slot-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: rgba(102, 126, 234, 0.5);
      font-size: 0.8em;
      text-align: center;
      padding: 10px;
    }

    .slot-number {
      font-size: 2em;
      margin-bottom: 5px;
      opacity: 0.3;
    }

    .slot-action {
      font-size: 0.7em;
      opacity: 0.6;
    }

    /* è‡ªå‹•é…ç½®ãƒ¢ãƒ¼ãƒ‰ */
    .auto-arrange-panel {
      background: rgba(102, 126, 234, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(102, 126, 234, 0.3);
    }

    .auto-arrange-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #667eea;
    }

    .dark .auto-arrange-title {
      color: #3498db;
    }

    .arrange-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .arrange-option {
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .dark .arrange-option {
      background: rgba(52, 73, 94, 0.8);
    }

    .arrange-option:hover {
      border-color: rgba(102, 126, 234, 0.5);
      transform: translateY(-2px);
    }

    .arrange-option.selected {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.2);
    }

    .option-title {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .option-desc {
      font-size: 0.8em;
      color: #666;
    }

    .dark .option-desc {
      color: #bdc3c7;
    }

    /* ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çµ±è¨ˆ */
    .collection-stats {
      display: flex;
      gap: 15px;
      align-items: center;
      justify-content: center;
      margin: 20px 0;
      flex-wrap: wrap;
    }

    .stat-item {
      background: rgba(255, 255, 255, 0.9);
      padding: 10px 15px;
      border-radius: 20px;
      font-size: 0.9em;
      font-weight: bold;
      color: #667eea;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }

    .dark .stat-item {
      background: rgba(52, 73, 94, 0.9);
      color: #3498db;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ - ã‚¹ãƒãƒ›ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ */
    @media (max-width: 768px) {
      .header {
        padding: 8px 15px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 8px;
      }
      
      .header h1 {
        font-size: 1.4em;
      }
      
      .binder-container {
        padding: 15px 10px;
      }
      
      .binder-page {
        padding: 20px 15px;
        margin-bottom: 20px;
      }
      
      /* ã‚¹ãƒãƒ›ç”¨ - 2x2ã‚°ãƒªãƒƒãƒ‰ã«å¤‰æ›´ */
      .binder-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
        margin: 15px 0;
      }
      
      /* ã‚«ãƒ¼ãƒ‰ã‚¹ãƒ­ãƒƒãƒˆã®ã‚¿ãƒƒãƒæ“ä½œæ”¹å–„ */
      .card-slot {
        min-height: 120px;
        border-width: 2px;
        touch-action: manipulation;
      }
      
      .empty-slot-content {
        padding: 8px;
      }
      
      .slot-number {
        font-size: 1.5em;
      }
      
      .slot-action {
        font-size: 0.8em;
      }
      
      /* ã‚¿ãƒƒãƒç”¨ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚º */
      .compact-controls {
        flex-wrap: wrap;
        justify-content: center;
        gap: 10px;
      }
      
      .compact-btn {
        padding: 12px 16px;
        font-size: 0.9em;
        min-width: 44px;
        min-height: 44px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* è‡ªå‹•é…ç½®ãƒ‘ãƒãƒ« */
      .arrange-options {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .arrange-option {
        padding: 16px;
        font-size: 1em;
      }
      
      /* çµ±è¨ˆè¡¨ç¤º */
      .collection-stats {
        flex-direction: column;
        gap: 10px;
        margin: 15px 0;
      }
      
      .stat-item {
        padding: 12px 20px;
        font-size: 1em;
        width: 100%;
        text-align: center;
        box-sizing: border-box;
      }
      
      /* ãƒšãƒ¼ã‚¸æƒ…å ± */
      .page-info {
        flex-direction: column;
        gap: 5px;
        text-align: right;
      }
      
      /* ã‚«ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
      .card-overlay {
        position: static;
        background: rgba(0,0,0,0.8);
        transform: none;
        border-radius: 0 0 8px 8px;
        padding: 6px;
      }
      
      .card-name {
        font-size: 0.7em;
      }
      
      .card-rarity {
        font-size: 0.6em;
      }
    }

    /* æ¥µå°ç”»é¢å¯¾å¿œ */
    @media (max-width: 480px) {
      .binder-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }
      
      .card-slot {
        max-width: 280px;
        margin: 0 auto;
      }
      
      .header h1 {
        font-size: 1.2em;
      }
      
      .compact-btn {
        padding: 10px 14px;
        font-size: 0.85em;
      }
    }

    /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ */
    @media (min-width: 769px) and (max-width: 1200px) {
      .binder-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
      }
    }

    /* ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .swipe-indicator {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8em;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 1001;
    }

    .swipe-indicator.show {
      opacity: 1;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ */
    .mobile-fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      color: white;
      font-size: 1.2em;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s ease;
      display: none;
    }

    .mobile-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }

    @media (max-width: 768px) {
      .mobile-fab {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes cardAppear {
      from {
        opacity: 0;
        transform: scale(0.8) rotateY(90deg);
      }
      to {
        opacity: 1;
        transform: scale(1) rotateY(0deg);
      }
    }

    .card-slot.new-card {
      animation: cardAppear 0.6s ease-out;
    }

    /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
    .card-slot.drag-over {
      border-color: #28a745;
      background: rgba(40, 167, 69, 0.2);
      transform: scale(1.05);
    }

    .card-slot.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>ğŸ´ ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒ€ãƒ¼</h1>
      <div class="compact-controls">
        <button class="compact-btn" onclick="toggleTheme()" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">ğŸŒ™</button>
        <button class="compact-btn" onclick="showAutoArrangePanel()" title="è‡ªå‹•é…ç½®">ğŸ“‹</button>
        <button class="compact-btn" onclick="toggleManualMode()" title="æ‰‹å‹•é…ç½®" id="manualModeBtn">âœ‹</button>
        <button class="compact-btn" onclick="saveBinderLayout()" title="ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿å­˜">ğŸ’¾</button>
        <button class="compact-btn" onclick="goHome()" title="ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹">ğŸ </button>
      </div>
    </div>
  </div>

  <div class="binder-container">
    <!-- è‡ªå‹•é…ç½®ãƒ‘ãƒãƒ« -->
    <div class="auto-arrange-panel" id="autoArrangePanel" style="display: none;">
      <div class="auto-arrange-title">ğŸ“‹ è‡ªå‹•é…ç½®ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
      <div class="arrange-options">
        <div class="arrange-option" onclick="autoArrange('rarity')">
          <div class="option-title">ãƒ¬ã‚¢ãƒªãƒ†ã‚£é †</div>
          <div class="option-desc">RRR â†’ RR â†’ R â†’ C ã®é †ã§é…ç½®</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('series')">
          <div class="option-title">ã‚·ãƒªãƒ¼ã‚ºé †</div>
          <div class="option-desc">åŒã˜ã‚·ãƒªãƒ¼ã‚ºã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('color')">
          <div class="option-title">ã‚«ãƒ©ãƒ¼é †</div>
          <div class="option-desc">è‰²ã”ã¨ã«ã¾ã¨ã‚ã¦é…ç½®</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('collection')">
          <div class="option-title">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç‡é †</div>
          <div class="option-desc">æ‰€æŒæ¸ˆã¿ â†’ æœªæ‰€æŒã®é †</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('release')">
          <div class="option-title">ç™ºå£²æ—¥é †</div>
          <div class="option-desc">æ–°ã—ã„ã‚·ãƒªãƒ¼ã‚ºã‹ã‚‰å¤ã„é †</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('custom')">
          <div class="option-title">ã‚«ã‚¹ã‚¿ãƒ é…ç½®</div>
          <div class="option-desc">ãŠæ°—ã«å…¥ã‚Šã‚«ãƒ¼ãƒ‰ã‚’å„ªå…ˆ</div>
        </div>
      </div>
    </div>

    <!-- ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³çµ±è¨ˆ -->
    <div class="collection-stats">
      <div class="stat-item" id="totalOwnedStat">æ‰€æŒ: 0æš</div>
      <div class="stat-item" id="collectionRateStat">æ‰€æŒç‡: 0%</div>
      <div class="stat-item" id="currentPageStat">ãƒšãƒ¼ã‚¸: 1</div>
      <div class="stat-item" id="filledSlotsStat">é…ç½®æ¸ˆã¿: 0/9</div>
    </div>

    <!-- ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="binderPages"></div>

    <!-- ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div class="collection-stats">
      <button class="compact-btn" onclick="previousPage()" id="prevPageBtn">â—€ å‰ã®ãƒšãƒ¼ã‚¸</button>
      <button class="compact-btn" onclick="nextPage()" id="nextPageBtn">æ¬¡ã®ãƒšãƒ¼ã‚¸ â–¶</button>
      <button class="compact-btn" onclick="addNewPage()">â• ãƒšãƒ¼ã‚¸è¿½åŠ </button>
    </div>
  </div>

  <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
  <button class="mobile-fab" onclick="toggleMobileMenu()" id="mobileFab">âš™ï¸</button>

  <!-- ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
  <div class="swipe-indicator" id="swipeIndicator"></div>

  <script>
    // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®çŠ¶æ…‹ç®¡ç†
    let binderState = {
      binderId: null,
      binderData: null,
      currentPage: 0,
      pages: [],
      totalCards: 0,
      ownedCards: 0,
      manualMode: false,
      autoArrangeVisible: false
    };

    let cardsData = [];
    let userCollection = {};
    let binderCollection = { binders: [] };
    
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®å¤‰æ•°
    let touchStartX = 0;
    let touchStartY = 0;
    let isMobile = window.innerWidth <= 768;
    let mobileMenuVisible = false;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', function() {
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒã‚¤ãƒ³ãƒ€ãƒ¼IDã‚’å–å¾—
      const urlParams = new URLSearchParams(window.location.search);
      binderState.binderId = urlParams.get('binderId');
      
      if (!binderState.binderId) {
        alert('ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãŒæŒ‡å®šã•ã‚Œã¦ã„ã¾ã›ã‚“');
        window.location.href = 'binder_collection.html';
        return;
      }

      loadCardData();
      loadUserCollection();
      loadBinderCollection();
      initializeBinder();
      updateStats();
      initializeMobileFeatures();
    });

    // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    async function loadCardData() {
      try {
        const response = await fetch('./json_file/card_data.json');
        cardsData = await response.json();
        binderState.totalCards = cardsData.length;
      } catch (error) {
        console.error('Failed to load card data:', error);
      }
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿
    function loadUserCollection() {
      const saved = localStorage.getItem('userCollection');
      userCollection = saved ? JSON.parse(saved) : {};
      
      // æ‰€æŒã‚«ãƒ¼ãƒ‰æ•°ã‚’è¨ˆç®—
      binderState.ownedCards = Object.values(userCollection).reduce((count, quantity) => {
        return count + (quantity > 0 ? 1 : 0);
      }, 0);
    }

    // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿
    function loadBinderCollection() {
      const saved = localStorage.getItem('binderCollection');
      if (saved) {
        binderCollection = JSON.parse(saved);
      }
      
      // æŒ‡å®šã•ã‚ŒãŸãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’å–å¾—
      binderState.binderData = binderCollection.binders.find(b => b.id == binderState.binderId);
      if (!binderState.binderData) {
        alert('æŒ‡å®šã•ã‚ŒãŸãƒã‚¤ãƒ³ãƒ€ãƒ¼ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
        window.location.href = 'binder_collection.html';
        return;
      }
      
      // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
      if (binderState.binderData.pages) {
        binderState.pages = binderState.binderData.pages;
      } else {
        binderState.pages = [createEmptyPage()];
        binderState.binderData.pages = binderState.pages;
      }
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
      updateBinderTitle();
    }

    // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    function initializeBinder() {
      // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€ç›´æ¥ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      renderBinder();
    }

    // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã®æ›´æ–°
    function updateBinderTitle() {
      const headerTitle = document.querySelector('.header h1');
      if (binderState.binderData && headerTitle) {
        headerTitle.innerHTML = `ğŸ´ ${binderState.binderData.name}`;
      }
    }

    // ç©ºã®ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
    function createEmptyPage() {
      return {
        id: Date.now(),
        name: `ãƒšãƒ¼ã‚¸ ${binderState.pages.length + 1}`,
        slots: Array(9).fill(null) // 3x3ã®9ã‚¹ãƒ­ãƒƒãƒˆ
      };
    }

    // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderBinder() {
      const container = document.getElementById('binderPages');
      container.innerHTML = '';

      if (binderState.pages.length === 0) {
        binderState.pages = [createEmptyPage()];
      }

      const currentPageData = binderState.pages[binderState.currentPage];
      if (!currentPageData) {
        binderState.currentPage = 0;
        return renderBinder();
      }

      // ãƒšãƒ¼ã‚¸ã®ä½œæˆ
      const pageDiv = document.createElement('div');
      pageDiv.className = 'binder-page';
      pageDiv.innerHTML = `
        <div class="page-header">
          <div class="page-title">${currentPageData.name}</div>
          <div class="page-info">
            <span>ãƒšãƒ¼ã‚¸ ${binderState.currentPage + 1} / ${binderState.pages.length}</span>
            <span>é…ç½®æ¸ˆã¿: ${currentPageData.slots.filter(slot => slot !== null).length}/9</span>
          </div>
        </div>
        <div class="binder-grid" id="currentPageGrid"></div>
      `;

      container.appendChild(pageDiv);
      renderPageSlots(currentPageData.slots);
      updateStats();
    }

    // ãƒšãƒ¼ã‚¸ã‚¹ãƒ­ãƒƒãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderPageSlots(slots) {
      const grid = document.getElementById('currentPageGrid');
      grid.innerHTML = '';

      slots.forEach((slotData, index) => {
        const slot = document.createElement('div');
        slot.className = 'card-slot';
        slot.setAttribute('data-slot-index', index);
        
        if (slotData) {
          // ã‚«ãƒ¼ãƒ‰ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹å ´åˆ
          slot.classList.add('occupied');
          const card = cardsData.find(c => c.id === slotData.cardId);
          if (card) {
            slot.innerHTML = `
              <img src="${card.cardImageURL || './images/placeholder.png'}" 
                   alt="${card.name}" 
                   class="card-image"
                   onerror="this.src='./images/placeholder.png'">
              <div class="card-overlay">
                <div class="card-name">${card.name}</div>
                <div class="card-rarity">${card.rarity || 'Unknown'}</div>
              </div>
            `;
          }
        } else {
          // ç©ºã®ã‚¹ãƒ­ãƒƒãƒˆ
          slot.innerHTML = `
            <div class="empty-slot-content">
              <div class="slot-number">${index + 1}</div>
              <div class="slot-action">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®</div>
            </div>
          `;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ 
        slot.addEventListener('click', () => openCardSelector(index));
        slot.addEventListener('dragover', handleDragOver);
        slot.addEventListener('drop', (e) => handleDrop(e, index));
        
        grid.appendChild(slot);
      });
    }

    // ã‚«ãƒ¼ãƒ‰é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openCardSelector(slotIndex) {
      if (!binderState.manualMode) {
        if (isMobile) {
          showMobileAlert('æ‰‹å‹•é…ç½®ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„', 'âš ï¸');
        } else {
          alert('æ‰‹å‹•é…ç½®ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„');
        }
        return;
      }

      // æ‰€æŒã‚«ãƒ¼ãƒ‰ã®ã¿ã‚’è¡¨ç¤ºã™ã‚‹ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’ä½œæˆ
      const ownedCards = cardsData.filter(card => userCollection[card.id] > 0);
      
      if (ownedCards.length === 0) {
        if (isMobile) {
          showMobileAlert('é…ç½®å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“', 'ğŸ“‹');
        } else {
          alert('é…ç½®å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
        }
        return;
      }

      if (isMobile) {
        // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®ã‚«ãƒ¼ãƒ‰é¸æŠUI
        showMobileCardSelector(slotIndex, ownedCards);
      } else {
        // ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç”¨ã®ç°¡æ˜“é¸æŠ
        const cardNames = ownedCards.map(card => `${card.name} (${card.rarity})`);
        const selectedIndex = prompt(`é…ç½®ã™ã‚‹ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„:\n${cardNames.map((name, i) => `${i}: ${name}`).join('\n')}\n\nç•ªå·ã‚’å…¥åŠ›:`);
        
        if (selectedIndex !== null && selectedIndex !== '') {
          const index = parseInt(selectedIndex);
          if (index >= 0 && index < ownedCards.length) {
            placeCardInSlot(slotIndex, ownedCards[index].id);
          }
        }
      }
    }

    // ã‚¹ãƒ­ãƒƒãƒˆã«ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®
    function placeCardInSlot(slotIndex, cardId) {
      const currentPage = binderState.pages[binderState.currentPage];
      currentPage.slots[slotIndex] = { cardId, placedAt: Date.now() };
      
      saveBinder();
      renderBinder();
    }

    // è‡ªå‹•é…ç½®
    function autoArrange(mode) {
      const ownedCards = cardsData.filter(card => userCollection[card.id] > 0);
      
      if (ownedCards.length === 0) {
        alert('é…ç½®å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
        return;
      }

      // ã‚½ãƒ¼ãƒˆæ–¹æ³•ã‚’é¸æŠ
      let sortedCards = [...ownedCards];
      switch(mode) {
        case 'rarity':
          sortedCards.sort((a, b) => {
            const rarityOrder = { 'RRR': 0, 'RR': 1, 'R': 2, 'C': 3 };
            return (rarityOrder[a.rarity] || 4) - (rarityOrder[b.rarity] || 4);
          });
          break;
        case 'series':
          sortedCards.sort((a, b) => (a.expansion || '').localeCompare(b.expansion || ''));
          break;
        case 'color':
          sortedCards.sort((a, b) => (a.cardColor || '').localeCompare(b.cardColor || ''));
          break;
        case 'collection':
          sortedCards.sort((a, b) => (userCollection[b.id] || 0) - (userCollection[a.id] || 0));
          break;
        case 'release':
          sortedCards.sort((a, b) => new Date(b.releaseDate || 0) - new Date(a.releaseDate || 0));
          break;
        case 'custom':
          // ãŠæ°—ã«å…¥ã‚Šæ©Ÿèƒ½ãŒã‚ã‚Œã°ä½¿ç”¨ï¼ˆä»Šå›ã¯åå‰é †ã§ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼‰
          sortedCards.sort((a, b) => a.name.localeCompare(b.name));
          break;
      }

      // å¿…è¦ãªãƒšãƒ¼ã‚¸æ•°ã‚’è¨ˆç®—
      const requiredPages = Math.ceil(sortedCards.length / 9);
      
      // ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ /èª¿æ•´
      while (binderState.pages.length < requiredPages) {
        binderState.pages.push(createEmptyPage());
      }

      // ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®
      let cardIndex = 0;
      for (let pageIndex = 0; pageIndex < requiredPages && cardIndex < sortedCards.length; pageIndex++) {
        const page = binderState.pages[pageIndex];
        page.slots = Array(9).fill(null);
        
        for (let slotIndex = 0; slotIndex < 9 && cardIndex < sortedCards.length; slotIndex++) {
          page.slots[slotIndex] = {
            cardId: sortedCards[cardIndex].id,
            placedAt: Date.now(),
            autoArranged: true
          };
          cardIndex++;
        }
      }

      binderState.currentPage = 0;
      saveBinder();
      renderBinder();
      hideAutoArrangePanel();
      
      alert(`${mode}é †ã§${sortedCards.length}æšã®ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®ã—ã¾ã—ãŸï¼`);
    }

    // çµ±è¨ˆã®æ›´æ–°
    function updateStats() {
      document.getElementById('totalOwnedStat').textContent = `æ‰€æŒ: ${binderState.ownedCards}æš`;
      
      const collectionRate = binderState.totalCards > 0 ? 
        Math.round((binderState.ownedCards / binderState.totalCards) * 100) : 0;
      document.getElementById('collectionRateStat').textContent = `æ‰€æŒç‡: ${collectionRate}%`;
      
      document.getElementById('currentPageStat').textContent = 
        `ãƒšãƒ¼ã‚¸: ${binderState.currentPage + 1}/${binderState.pages.length}`;
      
      const currentPage = binderState.pages[binderState.currentPage];
      const filledSlots = currentPage ? currentPage.slots.filter(slot => slot !== null).length : 0;
      document.getElementById('filledSlotsStat').textContent = `é…ç½®æ¸ˆã¿: ${filledSlots}/9`;
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function toggleTheme() {
      document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', document.body.classList.contains('dark'));
    }

    function showAutoArrangePanel() {
      const panel = document.getElementById('autoArrangePanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      binderState.autoArrangeVisible = panel.style.display === 'block';
    }

    function hideAutoArrangePanel() {
      document.getElementById('autoArrangePanel').style.display = 'none';
      binderState.autoArrangeVisible = false;
    }

    function toggleManualMode() {
      binderState.manualMode = !binderState.manualMode;
      const btn = document.getElementById('manualModeBtn');
      if (binderState.manualMode) {
        btn.classList.add('active');
        btn.textContent = 'âœ‹';
        btn.title = 'æ‰‹å‹•é…ç½®ãƒ¢ãƒ¼ãƒ‰ ON';
      } else {
        btn.classList.remove('active');
        btn.textContent = 'âœ‹';
        btn.title = 'æ‰‹å‹•é…ç½®ãƒ¢ãƒ¼ãƒ‰ OFF';
      }
    }

    function previousPage() {
      if (binderState.currentPage > 0) {
        binderState.currentPage--;
        renderBinder();
      }
    }

    function nextPage() {
      if (binderState.currentPage < binderState.pages.length - 1) {
        binderState.currentPage++;
        renderBinder();
      }
    }

    function addNewPage() {
      binderState.pages.push(createEmptyPage());
      binderState.currentPage = binderState.pages.length - 1;
      saveBinder();
      renderBinder();
    }

    function saveBinder() {
      if (binderState.binderData) {
        // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        binderState.binderData.pages = binderState.pages;
        binderState.binderData.pageCount = binderState.pages.length;
        binderState.binderData.cardCount = binderState.pages.reduce((count, page) => {
          return count + page.slots.filter(slot => slot !== null).length;
        }, 0);
        binderState.binderData.updatedAt = new Date().toISOString();
        
        // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’ä¿å­˜
        localStorage.setItem('binderCollection', JSON.stringify(binderCollection));
      }
    }

    function saveBinderLayout() {
      saveBinder();
      alert('ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
    }

    function goHome() {
      // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ä¸€è¦§ã«æˆ»ã‚‹
      window.location.href = 'binder_collection.html';
    }

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®å‡¦ç†
    function handleDragOver(e) {
      e.preventDefault();
      e.currentTarget.classList.add('drag-over');
    }

    function handleDrop(e, slotIndex) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®å®Ÿè£…ã¯ä»Šå¾Œã®æ‹¡å¼µã§å¯¾å¿œ
    }

    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å¾©å…ƒ
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
    }

    // ãƒ¢ãƒã‚¤ãƒ«ç”¨æ©Ÿèƒ½ã®åˆæœŸåŒ–
    function initializeMobileFeatures() {
      isMobile = window.innerWidth <= 768;
      
      // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã®è¨­å®š
      const binderContainer = document.querySelector('.binder-container');
      if (binderContainer && isMobile) {
        binderContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
        binderContainer.addEventListener('touchend', handleTouchEnd, { passive: false });
      }
      
      // ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆ
      window.addEventListener('resize', () => {
        isMobile = window.innerWidth <= 768;
      });
    }

    // ã‚¿ãƒƒãƒé–‹å§‹
    function handleTouchStart(e) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }

    // ã‚¿ãƒƒãƒçµ‚äº†ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—æ¤œå‡ºï¼‰
    function handleTouchEnd(e) {
      if (!touchStartX || !touchStartY) return;
      
      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;
      
      const diffX = touchStartX - touchEndX;
      const diffY = touchStartY - touchEndY;
      
      // æ°´å¹³ã‚¹ãƒ¯ã‚¤ãƒ—ã®æ¤œå‡ºï¼ˆç¸¦ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¦¨ã’ãªã„ã‚ˆã†ã«ï¼‰
      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
        if (diffX > 0) {
          // å·¦ã‚¹ãƒ¯ã‚¤ãƒ— - æ¬¡ã®ãƒšãƒ¼ã‚¸
          nextPage();
          showSwipeIndicator('æ¬¡ã®ãƒšãƒ¼ã‚¸ â†’');
        } else {
          // å³ã‚¹ãƒ¯ã‚¤ãƒ— - å‰ã®ãƒšãƒ¼ã‚¸
          previousPage();
          showSwipeIndicator('â† å‰ã®ãƒšãƒ¼ã‚¸');
        }
      }
      
      touchStartX = 0;
      touchStartY = 0;
    }

    // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
    function showSwipeIndicator(message) {
      const indicator = document.getElementById('swipeIndicator');
      indicator.textContent = message;
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 1500);
    }

    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚¢ãƒ©ãƒ¼ãƒˆ
    function showMobileAlert(message, icon = 'ğŸ“±') {
      const alertDiv = document.createElement('div');
      alertDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        z-index: 10000;
        text-align: center;
        font-size: 1.1em;
        max-width: 80vw;
        box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      `;
      alertDiv.innerHTML = `<div style="font-size: 1.5em; margin-bottom: 10px;">${icon}</div>${message}`;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 2500);
    }

    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚«ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
    function showMobileCardSelector(slotIndex, ownedCards) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
      `;
      
      const content = document.createElement('div');
      content.style.cssText = `
        background: white;
        border-radius: 15px;
        padding: 20px;
        max-width: 500px;
        margin: 0 auto;
        color: #333;
      `;
      
      content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ</h3>
          <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">âœ•</button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; max-height: 60vh; overflow-y: auto;">
          ${ownedCards.map((card, index) => `
            <div onclick="selectCard(${slotIndex}, '${card.id}'); this.closest('.modal').remove();" 
                 style="border: 2px solid #ddd; border-radius: 8px; padding: 8px; cursor: pointer; text-align: center; font-size: 0.8em;">
              <img src="${card.cardImageURL || './images/placeholder.png'}" 
                   style="width: 100%; height: 60px; object-fit: cover; border-radius: 4px; margin-bottom: 5px;"
                   onerror="this.src='./images/placeholder.png'">
              <div style="font-weight: bold; line-height: 1.2;">${card.name}</div>
              <div style="color: #666; font-size: 0.9em;">${card.rarity || 'Unknown'}</div>
            </div>
          `).join('')}
        </div>
      `;
      
      modal.className = 'modal';
      modal.appendChild(content);
      document.body.appendChild(modal);
    }

    // ã‚«ãƒ¼ãƒ‰é¸æŠï¼ˆãƒ¢ãƒã‚¤ãƒ«ç”¨ï¼‰
    function selectCard(slotIndex, cardId) {
      placeCardInSlot(slotIndex, cardId);
      showMobileAlert('ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®ã—ã¾ã—ãŸï¼', 'âœ…');
    }

    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
    function toggleMobileMenu() {
      mobileMenuVisible = !mobileMenuVisible;
      const fab = document.getElementById('mobileFab');
      
      if (mobileMenuVisible) {
        fab.textContent = 'âœ•';
        fab.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
        showAutoArrangePanel();
      } else {
        fab.textContent = 'âš™ï¸';
        fab.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
        hideAutoArrangePanel();
      }
    }
  </script>
</body>
</html>
