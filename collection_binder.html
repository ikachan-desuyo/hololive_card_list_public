<!DOCTYPE html>
<html lang="ja">
<!-- Version: 4.3.1-DRAG-DROP-COMPLETE - Added complete drag & drop functionality with visual effects and secondary sort features -->
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
  <meta http-equiv="Pragma" content="no-cache">
  <meta http-equiv="Expires" content="0">
  <title>ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒ€ãƒ¼</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: #333;
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden;
    }

    .dark { 
      background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%);
      color: #eee; 
    }

    /* ãƒ˜ãƒƒãƒ€ãƒ¼ - ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆåŒ– */
    .header {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(10px);
      padding: 10px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.1);
      position: sticky;
      top: 0;
      z-index: 1000;
      border-bottom: 2px solid rgba(102, 126, 234, 0.3);
    }

    .dark .header {
      background: rgba(44, 62, 80, 0.95);
      border-bottom-color: rgba(52, 152, 219, 0.3);
    }

    .header-content {
      display: flex;
      justify-content: space-between;
      align-items: center;
      max-width: 1400px;
      margin: 0 auto;
    }

    .header h1 {
      margin: 0;
      background: linear-gradient(45deg, #667eea, #764ba2);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
      font-size: 1.8em;
      font-weight: bold;
    }

    /* ã‚³ãƒ³ãƒ‘ã‚¯ãƒˆã‚³ãƒ³ãƒˆãƒ­ãƒ¼ãƒ« */
    .compact-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .compact-btn {
      padding: 6px 12px;
      border: none;
      border-radius: 20px;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
      font-size: 0.8em;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 2px 8px rgba(0,0,0,0.2);
    }

    .compact-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.3);
    }

    .compact-btn.active {
      background: linear-gradient(45deg, #28a745, #20c997);
    }

    /* ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¡ã‚¤ãƒ³é ˜åŸŸ */
    .binder-container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 20px;
    }

    /* ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ã‚¹ã‚¿ã‚¤ãƒ« */
    .binder-page {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      padding: 30px;
      margin-bottom: 30px;
      box-shadow: 0 8px 32px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }

    .dark .binder-page {
      background: rgba(52, 73, 94, 0.95);
      border-color: rgba(255,255,255,0.1);
    }

    .page-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      border-bottom: 2px solid rgba(102, 126, 234, 0.2);
      padding-bottom: 10px;
    }

    .page-title {
      font-size: 1.2em;
      font-weight: bold;
      color: #667eea;
    }

    .dark .page-title {
      color: #3498db;
    }

    .page-info {
      font-size: 0.9em;
      color: #666;
      display: flex;
      gap: 15px;
    }

    .dark .page-info {
      color: #bdc3c7;
    }

    /* ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚°ãƒªãƒƒãƒ‰ - å‹•çš„ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆå¯¾å¿œ */
    .binder-grid {
      display: grid;
      grid-template-columns: repeat(var(--grid-cols, 3), 1fr);
      gap: 15px;
      margin: 20px 0;
      max-width: calc(var(--grid-cols, 3) * 120px + (var(--grid-cols, 3) - 1) * 15px);
      margin-left: auto;
      margin-right: auto;
    }
    
    /* ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆåˆ¥ã®æœ€å¤§å¹…èª¿æ•´ */
    .binder-grid.layout-2x3 { max-width: 300px; }
    .binder-grid.layout-3x3 { max-width: 450px; }
    .binder-grid.layout-4x3 { max-width: 600px; }
    .binder-grid.layout-3x4 { max-width: 450px; }

    /* ã‚«ãƒ¼ãƒ‰ã‚¹ãƒ­ãƒƒãƒˆ */
    .card-slot {
      aspect-ratio: 63/88;
      border: 2px dashed rgba(102, 126, 234, 0.3);
      border-radius: 8px;
      position: relative;
      transition: all 0.3s ease;
      background: linear-gradient(145deg, rgba(255,255,255,0.1), rgba(0,0,0,0.05));
      cursor: pointer;
      overflow: hidden;
      max-width: 180px;
    }

    .card-slot:hover {
      border-color: rgba(102, 126, 234, 0.8);
      transform: scale(1.01);
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.2);
    }

    .card-slot.occupied {
      border: 2px solid rgba(40, 167, 69, 0.8);
      background: linear-gradient(145deg, rgba(40, 167, 69, 0.1), rgba(40, 167, 69, 0.05));
    }

    .card-slot.reserved {
      border: 2px solid rgba(255, 193, 7, 0.8);
      background: linear-gradient(145deg, rgba(255, 193, 7, 0.1), rgba(255, 193, 7, 0.05));
    }

    /* ã‚«ãƒ¼ãƒ‰ç”»åƒ */
    .card-container {
      width: 100%;
      height: 100%;
      position: relative;
      border-radius: 8px;
    }
    
    .card-image {
      width: 100%;
      height: 100%;
      object-fit: cover;
      border-radius: 8px;
      transition: transform 0.3s ease;
    }

    .card-slot:hover .card-image {
      transform: scale(1.02);
    }

    /* ã‚«ãƒ¼ãƒ‰æƒ…å ±ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
    .card-overlay {
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      background: linear-gradient(transparent, rgba(0,0,0,0.8));
      color: white;
      padding: 8px;
      transform: translateY(100%);
      transition: transform 0.3s ease;
    }

    .card-slot:hover .card-overlay {
      transform: translateY(0);
    }

    .card-name {
      font-size: 0.7em;
      font-weight: bold;
      margin-bottom: 2px;
    }

    .card-rarity {
      font-size: 0.6em;
      opacity: 0.9;
    }

    /* ç©ºãã‚¹ãƒ­ãƒƒãƒˆã®è¡¨ç¤º */
    .empty-slot-content {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      height: 100%;
      color: rgba(102, 126, 234, 0.5);
      font-size: 0.8em;
      text-align: center;
      padding: 10px;
    }

    .slot-number {
      font-size: 2em;
      margin-bottom: 5px;
      opacity: 0.3;
    }

    .slot-action {
      font-size: 0.7em;
      opacity: 0.6;
    }

    /* è‡ªå‹•é…ç½®ãƒ¢ãƒ¼ãƒ‰ */
    .auto-arrange-panel {
      background: rgba(102, 126, 234, 0.1);
      border-radius: 10px;
      padding: 15px;
      margin-bottom: 20px;
      border: 1px solid rgba(102, 126, 234, 0.3);
    }

    .auto-arrange-title {
      font-weight: bold;
      margin-bottom: 10px;
      color: #667eea;
    }

    .dark .auto-arrange-title {
      color: #3498db;
    }

    .arrange-options {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 10px;
    }

    .arrange-option {
      background: rgba(255, 255, 255, 0.8);
      border: 2px solid transparent;
      border-radius: 8px;
      padding: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      text-align: center;
    }

    .dark .arrange-option {
      background: rgba(52, 73, 94, 0.8);
    }

    .arrange-option:hover {
      border-color: rgba(102, 126, 234, 0.5);
      transform: translateY(-2px);
    }

    .arrange-option.selected {
      border-color: #667eea;
      background: rgba(102, 126, 234, 0.2);
    }

    .option-title {
      font-weight: bold;
      margin-bottom: 5px;
    }

    .option-desc {
      font-size: 0.8em;
      color: #666;
    }

    .dark .option-desc {
      color: #bdc3c7;
    }

    /* Sãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®å…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ */
    .s-rarity-effect {
      position: relative;
      overflow: hidden;
    }

    .s-rarity-effect::before {
      content: '';
      position: absolute;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: linear-gradient(
        45deg,
        transparent 20%,
        rgba(255, 255, 255, 0.1) 30%,
        rgba(255, 255, 255, 0.3) 50%,
        rgba(255, 255, 255, 0.1) 70%,
        transparent 80%
      );
      animation: shine 2s ease-in-out infinite;
      pointer-events: none;
      z-index: 1;
    }

    .s-rarity-effect::after {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: radial-gradient(
        circle at center,
        rgba(255, 215, 0, 0.1) 0%,
        rgba(255, 255, 255, 0.05) 50%,
        transparent 70%
      );
      pointer-events: none;
      z-index: 1;
    }

    @keyframes shine {
      0% {
        transform: translate(-100%, -100%) rotate(45deg);
      }
      50% {
        transform: translate(0%, 0%) rotate(45deg);
      }
      100% {
        transform: translate(100%, 100%) rotate(45deg);
      }
    }

    .s-rarity-effect .card-image {
      position: relative;
      z-index: 0;
    }

    /* ãƒ¬ã‚¹ãƒãƒ³ã‚·ãƒ–å¯¾å¿œ - ã‚¹ãƒãƒ›ãƒ•ã‚¡ãƒ¼ã‚¹ãƒˆ */
    @media (max-width: 768px) {
      .header {
        padding: 6px 10px;
      }
      
      .header-content {
        flex-direction: column;
        gap: 6px;
      }
      
      .header h1 {
        font-size: 1.2em;
      }
      
      .binder-container {
        padding: 10px 8px;
      }
      
      .binder-page {
        padding: 15px 10px;
        margin-bottom: 15px;
      }
      
      /* ã‚¹ãƒãƒ›ç”¨ - 3x3ã‚°ãƒªãƒƒãƒ‰ã®ã¾ã¾ã€ã‚µã‚¤ã‚ºèª¿æ•´ */
      .binder-grid {
        grid-template-columns: repeat(3, 1fr);
        gap: 8px;
        margin: 15px 0;
        max-width: 100%;
      }
      
      /* ã‚«ãƒ¼ãƒ‰ã‚¹ãƒ­ãƒƒãƒˆã®ã‚¿ãƒƒãƒæ“ä½œæ”¹å–„ */
      .card-slot {
        min-height: 80px;
        max-width: none;
        border-width: 1px;
        border-radius: 6px;
        touch-action: manipulation;
      }
      
      .empty-slot-content {
        padding: 4px;
      }
      
      .slot-number {
        font-size: 1.2em;
      }
      
      .slot-action {
        font-size: 0.65em;
      }
      
      /* ã‚¿ãƒƒãƒç”¨ãƒœã‚¿ãƒ³ã‚µã‚¤ã‚º */
      .compact-controls {
        flex-wrap: wrap;
        justify-content: center;
        gap: 6px;
      }
      
      .compact-btn {
        padding: 8px 12px;
        font-size: 0.8em;
        min-width: 40px;
        min-height: 40px;
        display: flex;
        align-items: center;
        justify-content: center;
      }
      
      /* è‡ªå‹•é…ç½®ãƒ‘ãƒãƒ« */
      .arrange-options {
        grid-template-columns: 1fr;
        gap: 8px;
      }
      
      .arrange-option {
        padding: 12px;
        font-size: 0.9em;
      }
      
      /* ãƒšãƒ¼ã‚¸æƒ…å ± */
      .page-info {
        flex-direction: column;
        gap: 4px;
        text-align: right;
        font-size: 0.8em;
      }
      
      /* ã‚«ãƒ¼ãƒ‰ã‚ªãƒ¼ãƒãƒ¼ãƒ¬ã‚¤ */
      .card-overlay {
        position: static;
        background: rgba(0,0,0,0.8);
        transform: none;
        border-radius: 0 0 6px 6px;
        padding: 4px;
      }
      
      .card-name {
        font-size: 0.6em;
      }
      
      .card-rarity {
        font-size: 0.55em;
      }
    }

    /* æ¥µå°ç”»é¢å¯¾å¿œ */
    @media (max-width: 480px) {
      .header h1 {
        font-size: 1.1em;
      }
      
      .compact-btn {
        padding: 8px 10px;
        font-size: 0.75em;
        min-width: 36px;
        min-height: 36px;
      }
      
      .binder-grid {
        gap: 6px;
      }
      
      .card-slot {
        min-height: 70px;
        border-radius: 4px;
      }
      
      .slot-number {
        font-size: 1em;
      }
      
      .slot-action {
        font-size: 0.6em;
      }
    }

    /* ã‚¿ãƒ–ãƒ¬ãƒƒãƒˆå¯¾å¿œ */
    @media (min-width: 769px) and (max-width: 1200px) {
      .binder-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 18px;
      }
    }

    /* ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ç”¨ã‚¹ã‚¿ã‚¤ãƒ« */
    .swipe-indicator {
      position: fixed;
      bottom: 20px;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(0,0,0,0.7);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 0.8em;
      opacity: 0;
      transition: opacity 0.3s ease;
      pointer-events: none;
      z-index: 1001;
    }

    .swipe-indicator.show {
      opacity: 1;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ */
    .mobile-fab {
      position: fixed;
      bottom: 80px;
      right: 20px;
      width: 56px;
      height: 56px;
      border-radius: 50%;
      background: linear-gradient(45deg, #667eea, #764ba2);
      border: none;
      color: white;
      font-size: 1.2em;
      box-shadow: 0 4px 16px rgba(0,0,0,0.3);
      cursor: pointer;
      z-index: 1000;
      transition: all 0.3s ease;
      display: none;
    }

    .mobile-fab:hover {
      transform: scale(1.1);
      box-shadow: 0 6px 20px rgba(0,0,0,0.4);
    }

    @media (max-width: 768px) {
      .mobile-fab {
        display: flex;
        align-items: center;
        justify-content: center;
      }
    }

    /* ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ */
    @keyframes cardAppear {
      from {
        opacity: 0;
        transform: scale(0.8) rotateY(90deg);
      }
      to {
        opacity: 1;
        transform: scale(1) rotateY(0deg);
      }
    }

    .card-slot.new-card {
      animation: cardAppear 0.6s ease-out;
    }

    /* ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ— */
    .card-slot.drag-over {
      border-color: #28a745;
      background: rgba(40, 167, 69, 0.2);
      transform: scale(1.05);
      transition: all 0.2s ease;
      box-shadow: 0 0 15px rgba(40, 167, 69, 0.5);
    }

    .card-slot.dragging {
      opacity: 0.5;
      transform: rotate(5deg);
      transition: all 0.2s ease;
    }
    
    .card-container[draggable="true"] {
      cursor: grab;
      transition: all 0.2s ease;
    }
    
    .card-container[draggable="true"]:hover {
      transform: scale(1.02);
    }
    
    .card-container.dragging {
      cursor: grabbing;
      transform: rotate(5deg) scale(0.9);
      z-index: 1000;
      transition: all 0.2s ease;
    }

    /* ã‚«ãƒ¼ãƒ‰é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« */
    .card-selector-modal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      z-index: 2000;
    }

    .card-selector-modal.show {
      display: block;
    }

    .modal-backdrop {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0, 0, 0, 0.8);
      backdrop-filter: blur(5px);
    }

    .modal-content {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      background: white;
      border-radius: 15px;
      width: 90%;
      max-width: 800px;
      max-height: 90vh;
      overflow: hidden;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      display: flex;
      flex-direction: column;
    }

    .dark .modal-content {
      background: #34495e;
      color: #eee;
    }

    .modal-header {
      padding: 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
    }

    .modal-header h3 {
      margin: 0;
      font-size: 1.3em;
    }

    .modal-close-btn {
      background: none;
      border: none;
      color: white;
      font-size: 1.5em;
      cursor: pointer;
      padding: 5px;
      border-radius: 50%;
      width: 35px;
      height: 35px;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background-color 0.3s ease;
    }

    .modal-close-btn:hover {
      background: rgba(255, 255, 255, 0.2);
    }

    .modal-search {
      padding: 15px 20px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.1);
      background: #f8f9fa;
    }

    .dark .modal-search {
      background: rgba(52, 73, 94, 0.8);
      border-bottom-color: rgba(255, 255, 255, 0.1);
    }

    .modal-search input {
      width: 100%;
      padding: 10px 15px;
      border: 1px solid #ddd;
      border-radius: 8px;
      font-size: 1em;
      margin-bottom: 10px;
      box-sizing: border-box;
    }

    .dark .modal-search input {
      background: rgba(255, 255, 255, 0.1);
      border-color: rgba(255, 255, 255, 0.2);
      color: #eee;
    }

    .search-filters {
      display: flex;
      gap: 10px;
    }

    .search-filters select {
      flex: 1;
      padding: 8px 12px;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 0.9em;
      background: white;
    }

    .dark .search-filters select {
      background: #3a3a3a;
      border-color: #555;
      color: #eee;
    }
    
    .dark .search-filters select option {
      background: #3a3a3a;
      color: #eee;
    }

    /* è‡ªå‹•é…ç½®ãƒ‘ãƒãƒ«å†…ã®selectè¦ç´  */
    .auto-arrange-panel select {
      background: white;
      border: 1px solid #ddd;
      color: #333;
    }
    
    .dark .auto-arrange-panel select {
      background: #3a3a3a;
      border-color: #555;
      color: #eee;
    }
    
    .dark .auto-arrange-panel select option {
      background: #3a3a3a;
      color: #eee;
    }
    
    /* è‡ªå‹•é…ç½®ãƒ‘ãƒãƒ«å†…ã®ãƒã‚§ãƒƒã‚¯ãƒœãƒƒã‚¯ã‚¹ */
    .auto-arrange-panel input[type="checkbox"] {
      margin-right: 5px;
    }
    
    .dark .auto-arrange-panel input[type="checkbox"] {
      accent-color: #4CAF50;
    }

    .card-grid {
      flex: 1;
      overflow-y: auto;
      padding: 20px;
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
      gap: 15px;
      max-height: 50vh;
    }

    .card-item {
      border: 2px solid transparent;
      border-radius: 8px;
      cursor: pointer;
      transition: all 0.3s ease;
      background: #f8f9fa;
      overflow: hidden;
      position: relative;
    }

    .card-item:hover {
      border-color: #667eea;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
    }

    .card-item.selected {
      border-color: #28a745;
      background: rgba(40, 167, 69, 0.1);
    }

    .dark .card-item {
      background: rgba(52, 73, 94, 0.6);
    }

    .dark .card-item.selected {
      background: rgba(40, 167, 69, 0.2);
    }

    .card-item img {
      width: 100%;
      height: auto;
      aspect-ratio: 63/88;
      object-fit: cover;
      display: block;
    }

    .card-info {
      padding: 8px;
      text-align: center;
    }

    .card-info .name {
      font-size: 0.8em;
      font-weight: bold;
      margin-bottom: 3px;
      color: #333;
      overflow: hidden;
      text-overflow: ellipsis;
      white-space: nowrap;
    }

    .dark .card-info .name {
      color: #eee;
    }

    .card-info .rarity {
      font-size: 0.7em;
      color: #666;
      padding: 2px 6px;
      border-radius: 10px;
      display: inline-block;
      background: rgba(0, 0, 0, 0.1);
    }

    .dark .card-info .rarity {
      color: #bbb;
      background: rgba(255, 255, 255, 0.1);
    }

    .rarity-RRR {
      background: linear-gradient(45deg, #ff6b6b, #ee5a52) !important;
      color: white !important;
    }

    .rarity-RR {
      background: linear-gradient(45deg, #4ecdc4, #44a08d) !important;
      color: white !important;
    }

    .rarity-R {
      background: linear-gradient(45deg, #45b7d1, #3498db) !important;
      color: white !important;
    }

    .rarity-C {
      background: linear-gradient(45deg, #96ceb4, #85c7a8) !important;
      color: white !important;
    }

    .modal-footer {
      padding: 15px 20px;
      border-top: 1px solid rgba(0, 0, 0, 0.1);
      display: flex;
      gap: 10px;
      justify-content: flex-end;
      background: #f8f9fa;
    }

    .dark .modal-footer {
      background: rgba(52, 73, 94, 0.8);
      border-top-color: rgba(255, 255, 255, 0.1);
    }

    .btn {
      padding: 10px 20px;
      border: none;
      border-radius: 8px;
      font-size: 0.9em;
      cursor: pointer;
      transition: all 0.3s ease;
      font-weight: bold;
    }

    .btn-primary {
      background: linear-gradient(45deg, #667eea, #764ba2);
      color: white;
    }

    .btn-primary:hover {
      transform: translateY(-1px);
      box-shadow: 0 3px 10px rgba(102, 126, 234, 0.3);
    }

    .btn-secondary {
      background: #6c757d;
      color: white;
    }

    .btn-secondary:hover {
      background: #5a6268;
    }

    /* ãƒ¢ãƒã‚¤ãƒ«å¯¾å¿œ */
    @media (max-width: 768px) {
      .modal-content {
        width: 95%;
        max-height: 95vh;
      }

      .modal-header {
        padding: 15px;
      }

      .modal-header h3 {
        font-size: 1.1em;
      }

      .modal-search {
        padding: 10px 15px;
      }

      .search-filters {
        flex-direction: column;
        gap: 8px;
      }

      .card-grid {
        grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
        gap: 10px;
        padding: 15px;
        max-height: 45vh;
      }

      .card-info {
        padding: 6px;
      }

      .card-info .name {
        font-size: 0.75em;
      }

      .card-info .rarity {
        font-size: 0.65em;
      }

      .modal-footer {
        padding: 12px 15px;
        flex-direction: column;
      }

      .btn {
        padding: 12px;
        font-size: 1em;
      }
    }
    @keyframes fadeInOut {
      0% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
      20% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      80% { opacity: 1; transform: translate(-50%, -50%) scale(1); }
      100% { opacity: 0; transform: translate(-50%, -50%) scale(0.8); }
    }

    .temporary-message {
      animation: fadeInOut 2s ease-in-out;
    }
  </style>
</head>
<body>
  <div class="header">
    <div class="header-content">
      <h1>ğŸ´ ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒã‚¤ãƒ³ãƒ€ãƒ¼</h1>
      <div class="compact-controls">
        <button class="compact-btn" onclick="toggleTheme()" title="ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">ğŸŒ™</button>
        <button class="compact-btn" onclick="showAutoArrangePanel()" title="è‡ªå‹•é…ç½®">ğŸ“‹</button>
        <button class="compact-btn" onclick="toggleManualMode()" title="æ‰‹å‹•é…ç½®" id="manualModeBtn">âœ‹</button>
        <button class="compact-btn" onclick="addTestCards()" title="ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰è¿½åŠ ">ğŸ´</button>
        <button class="compact-btn" onclick="saveBinderLayout()" title="ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆä¿å­˜">ğŸ’¾</button>
        <button class="compact-btn" onclick="goHome()" title="ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹">ğŸ </button>
      </div>
    </div>
  </div>

  <div class="binder-container">
    <!-- è‡ªå‹•é…ç½®ãƒ‘ãƒãƒ« -->
    <div class="auto-arrange-panel" id="autoArrangePanel" style="display: none;">
      <div class="auto-arrange-title">ğŸ“‹ è‡ªå‹•é…ç½®ã‚ªãƒ—ã‚·ãƒ§ãƒ³</div>
      
      <!-- é…ç½®è¨­å®š -->
      <div style="margin-bottom: 15px; padding: 15px; background: rgba(255,255,255,0.1); border-radius: 8px;">
        <div style="display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
          <label style="display: flex; align-items: center; gap: 5px;">
            <span>é †åº:</span>
            <select id="sortOrderSelect" style="padding: 5px; border-radius: 4px; border: 1px solid #ddd;">
              <option value="desc">é™é † (é«˜â†’ä½)</option>
              <option value="asc">æ˜‡é † (ä½â†’é«˜)</option>
            </select>
          </label>
          <label style="display: flex; align-items: center; gap: 5px;">
            <span>äºŒæ¬¡ã‚½ãƒ¼ãƒˆ:</span>
            <select id="secondarySortSelect" style="padding: 5px; border-radius: 4px; border: 1px solid #ddd; min-width: 120px;">
              <option value="">ãªã—</option>
              <option value="cardId">ã‚«ãƒ¼ãƒ‰ç•ªå·é †</option>
              <option value="release">ç™ºå£²æ—¥é †</option>
              <option value="name">åå‰é †</option>
              <option value="product">åéŒ²å•†å“é †</option>
            </select>
          </label>
          <label style="display: flex; align-items: center; gap: 5px;">
            <span>åéŒ²å•†å“:</span>
            <select id="productSelect" style="padding: 5px; border-radius: 4px; border: 1px solid #ddd; min-width: 120px;">
              <option value="">ã™ã¹ã¦ã®å•†å“</option>
            </select>
          </label>
        </div>
        <div style="margin-top: 10px; display: flex; gap: 15px; align-items: center; flex-wrap: wrap;">
          <label style="display: flex; align-items: center; gap: 5px;">
            <input type="checkbox" id="preserveEmptySlots" style="margin: 0;">
            <span>ç©ºã‚¹ãƒ­ãƒƒãƒˆä¿æŒ (æŒã£ã¦ã„ãªã„ã‚«ãƒ¼ãƒ‰ã¯ç©ºã«)</span>
          </label>
        </div>
      </div>
      
      <div class="arrange-options">
        <div class="arrange-option" onclick="autoArrange('rarity')">
          <div class="option-title">ãƒ¬ã‚¢ãƒªãƒ†ã‚£é †</div>
          <div class="option-desc">SEC â†’ OUR â†’ UR â†’ SR ã®é †ã§é…ç½®</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('series')">
          <div class="option-title">ã‚·ãƒªãƒ¼ã‚ºé †</div>
          <div class="option-desc">åŒã˜ã‚·ãƒªãƒ¼ã‚ºã§ã‚°ãƒ«ãƒ¼ãƒ—åŒ–</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('product')">
          <div class="option-title">åéŒ²å•†å“é †</div>
          <div class="option-desc">é¸æŠã—ãŸå•†å“ã®ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('collection')">
          <div class="option-title">ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ç‡é †</div>
          <div class="option-desc">æ‰€æŒæ¸ˆã¿ â†’ æœªæ‰€æŒã®é †</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('release')">
          <div class="option-title">ç™ºå£²æ—¥é †</div>
          <div class="option-desc">æ–°ã—ã„ã‚·ãƒªãƒ¼ã‚ºã‹ã‚‰å¤ã„é †</div>
        </div>
        <div class="arrange-option" onclick="autoArrange('custom')">
          <div class="option-title">ã‚«ã‚¹ã‚¿ãƒ é…ç½®</div>
          <div class="option-desc">ãŠæ°—ã«å…¥ã‚Šã‚«ãƒ¼ãƒ‰ã‚’å„ªå…ˆ</div>
        </div>
      </div>
    </div>

    <!-- ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒšãƒ¼ã‚¸ã‚³ãƒ³ãƒ†ãƒŠ -->
    <div id="binderPages"></div>

    <!-- ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
    <div style="text-align: center; margin: 20px 0;">
      <!-- åŸºæœ¬ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³ -->
      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
        <button class="compact-btn" onclick="goToFirstPage()" id="firstPageBtn" title="æœ€åˆã®ãƒšãƒ¼ã‚¸">â®ï¸ æœ€åˆ</button>
        <button class="compact-btn" onclick="previousPage()" id="prevPageBtn" title="å‰ã®ãƒšãƒ¼ã‚¸">â—€ å‰</button>
        
        <!-- ãƒšãƒ¼ã‚¸ç•ªå·å…¥åŠ› -->
        <div style="display: flex; align-items: center; gap: 5px;">
          <input type="number" id="pageNumberInput" min="1" style="width: 60px; padding: 5px; border: 1px solid #ddd; border-radius: 4px; text-align: center;" placeholder="1">
          <button class="compact-btn" onclick="goToPage()" title="æŒ‡å®šãƒšãƒ¼ã‚¸ã«ç§»å‹•">ç§»å‹•</button>
        </div>
        
        <button class="compact-btn" onclick="nextPage()" id="nextPageBtn" title="æ¬¡ã®ãƒšãƒ¼ã‚¸">æ¬¡ â–¶</button>
        <button class="compact-btn" onclick="goToLastPage()" id="lastPageBtn" title="æœ€å¾Œã®ãƒšãƒ¼ã‚¸">æœ€å¾Œ â­ï¸</button>
      </div>
      
      <!-- ãƒã‚¤ãƒ³ãƒ€ãƒ¼ç®¡ç†ãƒœã‚¿ãƒ³ -->
      <div style="display: flex; gap: 10px; justify-content: center; flex-wrap: wrap; margin-bottom: 15px;">
        <button class="compact-btn" onclick="addNewPage()" title="æ–°ã—ã„ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ ">â• ãƒšãƒ¼ã‚¸è¿½åŠ </button>
        <button class="compact-btn" onclick="toggleViewMode()" id="viewModeBtn" title="é–²è¦§/ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿">ğŸ‘ï¸ é–²è¦§ãƒ¢ãƒ¼ãƒ‰</button>
        <button class="compact-btn" onclick="clearAllCards()" id="clearBtn" title="å…¨ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤" style="background: #f44336; color: white;">ğŸ—‘ï¸ åˆæœŸåŒ–</button>
      </div>
    </div>
  </div>

  <!-- ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ•ãƒ­ãƒ¼ãƒ†ã‚£ãƒ³ã‚°ãƒœã‚¿ãƒ³ -->
  <button class="mobile-fab" onclick="toggleMobileMenu()" id="mobileFab">âš™ï¸</button>

  <!-- ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
  <div class="swipe-indicator" id="swipeIndicator"></div>

  <!-- ã‚«ãƒ¼ãƒ‰é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ« -->
  <div class="card-selector-modal" id="cardSelectorModal">
    <div class="modal-backdrop" onclick="closeCardSelector()"></div>
    <div class="modal-content">
      <div class="modal-header">
        <h3>ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ</h3>
        <button class="modal-close-btn" onclick="closeCardSelector()">Ã—</button>
      </div>
      <div class="modal-search">
        <input type="text" id="cardSearchInput" placeholder="ã‚«ãƒ¼ãƒ‰åã§æ¤œç´¢..." onkeyup="filterCards()">
        <div class="search-filters">
          <select id="rarityFilter" onchange="filterCards()">
            <option value="">ã™ã¹ã¦ã®ãƒ¬ã‚¢ãƒªãƒ†ã‚£</option>
            <option value="SEC">SEC</option>
            <option value="OUR">OUR</option>
            <option value="UR">UR</option>
            <option value="SY">SY</option>
            <option value="OSR">OSR</option>
            <option value="SR">SR</option>
            <option value="P">P</option>
            <option value="S">S</option>
            <option value="OC">OC</option>
            <option value="RR">RR</option>
            <option value="R">R</option>
            <option value="U">U</option>
            <option value="C">C</option>
          </select>
          <select id="cardTypeFilter" onchange="filterCards()">
            <option value="">ã™ã¹ã¦ã®ã‚¿ã‚¤ãƒ—</option>
            <option value="ãƒ›ãƒ­ãƒ¡ãƒ³">ãƒ›ãƒ­ãƒ¡ãƒ³</option>
            <option value="Buzzãƒ›ãƒ­ãƒ¡ãƒ³">Buzzãƒ›ãƒ­ãƒ¡ãƒ³</option>
            <option value="ã‚µãƒãƒ¼ãƒˆãƒ»ã‚¢ã‚¤ãƒ†ãƒ ">ã‚¢ã‚¤ãƒ†ãƒ </option>
            <option value="ã‚µãƒãƒ¼ãƒˆãƒ»ã‚¤ãƒ™ãƒ³ãƒˆ">ã‚¤ãƒ™ãƒ³ãƒˆ</option>
            <option value="ã‚µãƒãƒ¼ãƒˆãƒ»ãƒ„ãƒ¼ãƒ«">ãƒ„ãƒ¼ãƒ«</option>
            <option value="LIMITED">LIMITED</option>
          </select>
        </div>
      </div>
      <div class="card-grid" id="cardGrid">
        <!-- ã‚«ãƒ¼ãƒ‰ãŒã“ã“ã«å‹•çš„ã«è¡¨ç¤ºã•ã‚Œã¾ã™ -->
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" onclick="closeCardSelector()">ã‚­ãƒ£ãƒ³ã‚»ãƒ«</button>
        <button class="btn btn-primary" onclick="removeCardFromSlot()">ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤</button>
        <button class="btn btn-primary" onclick="placeSelectedCard()">ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®</button>
      </div>
    </div>
  </div>

  <script>
    // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®çŠ¶æ…‹ç®¡ç†
    let binderState = {
      binderId: null,
      binderData: null,
      currentPage: 0,
      pages: [],
      totalCards: 0,
      ownedCards: 0,
      manualMode: false,
      autoArrangeVisible: false,
      viewMode: false // false: ç·¨é›†ãƒ¢ãƒ¼ãƒ‰, true: é–²è¦§ãƒ¢ãƒ¼ãƒ‰
    };

    let cardsData = [];
    let userCollection = {};
    let binderCollection = { binders: [] };
    
    // ã‚«ãƒ¼ãƒ‰é¸æŠé–¢é€£ã®å¤‰æ•°
    let currentSlotIndex = null;
    let selectedCardId = null;
    let availableCards = [];
    
    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã®å¤‰æ•°
    let touchStartX = 0;
    let touchStartY = 0;
    let isMobile = window.innerWidth <= 768;
    let mobileMenuVisible = false;

    // åˆæœŸåŒ–
    document.addEventListener('DOMContentLoaded', async function() {
      console.log('DOMContentLoaded fired');
      
      // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‹ã‚‰ãƒã‚¤ãƒ³ãƒ€ãƒ¼IDã‚’å–å¾—
      const urlParams = new URLSearchParams(window.location.search);
      binderState.binderId = urlParams.get('binderId');
      
      console.log('Binder ID from URL:', binderState.binderId);
      
      if (!binderState.binderId) {
        console.log('No binder ID specified, checking for existing binders...');
        
        // æ—¢å­˜ã®ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
        const saved = localStorage.getItem('binderCollection');
        if (saved) {
          const collection = JSON.parse(saved);
          if (collection.binders && collection.binders.length > 0) {
            // æœ€åˆã®ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
            const firstBinder = collection.binders[0];
            console.log('Redirecting to first binder:', firstBinder.id);
            window.location.href = `collection_binder.html?binderId=${firstBinder.id}`;
            return;
          }
        }
        
        // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãŒå­˜åœ¨ã—ãªã„å ´åˆã€ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ãƒšãƒ¼ã‚¸ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆ
        console.log('No binders found, redirecting to binder collection');
        alert('ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãŒã‚ã‚Šã¾ã›ã‚“ã€‚æ–°ã—ã„ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆã—ã¦ãã ã•ã„ã€‚');
        window.location.href = 'binder_collection.html';
        return;
      }

      // éåŒæœŸã§ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ã€å®Œäº†ã‚’å¾…ã¤
      await loadCardData();
      loadUserCollection(); // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿èª­ã¿è¾¼ã¿å¾Œã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’èª­ã¿è¾¼ã¿
      loadBinderCollection();
      initializeBinder();
      updateStats();
      initializeMobileFeatures();
      
      console.log('Initialization complete');
      
      // ãƒ‡ãƒãƒƒã‚°ç”¨: å¼·åˆ¶çš„ã«ã‚¯ãƒªãƒƒã‚¯ãƒ†ã‚¹ãƒˆ
      setTimeout(() => {
        const slots = document.querySelectorAll('.card-slot');
        console.log('Found slots:', slots.length);
        slots.forEach((slot, index) => {
          console.log(`Slot ${index}:`, slot);
        });
      }, 1000);
    });

    // ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿
    async function loadCardData() {
      try {
        console.log('Loading card data...');
        const response = await fetch('./json_file/card_data.json');
        const rawCardData = await response.json();
        console.log('Raw card data loaded:', Object.keys(rawCardData).length, 'entries');
        console.log('First 3 raw entries:', Object.keys(rawCardData).slice(0, 3));
        
        // ã‚ªãƒ–ã‚¸ã‚§ã‚¯ãƒˆã‹ã‚‰é…åˆ—ã«å¤‰æ›
        cardsData = Object.entries(rawCardData).map(([key, card]) => ({
          ...card,
          id: key,  // keyã‚’idã¨ã—ã¦è¨­å®šï¼ˆcard_list.htmlã¨åŒã˜æ–¹å¼ï¼‰
          cardImageURL: card.image_url  // äº’æ›æ€§ã®ãŸã‚
        }));
        
        console.log('Card data converted to array:', cardsData.length, 'cards');
        console.log('First 3 converted cards:', cardsData.slice(0, 3).map(c => ({id: c.id, name: c.name})));
        
        binderState.totalCards = cardsData.length;
        
        // cardsDataãŒé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
        if (!Array.isArray(cardsData)) {
          console.error('Card data is not an array:', cardsData);
          cardsData = [];
        }
        
        // åéŒ²å•†å“ãƒªã‚¹ãƒˆã‚’åˆæœŸåŒ–
        initializeProductList();
      } catch (error) {
        console.error('Failed to load card data:', error);
        cardsData = []; // ã‚¨ãƒ©ãƒ¼æ™‚ã¯ç©ºé…åˆ—ã«è¨­å®š
      }
    }

    // åéŒ²å•†å“ãƒªã‚¹ãƒˆã®åˆæœŸåŒ–
    function initializeProductList() {
      const productSelect = document.getElementById('productSelect');
      if (!productSelect || !Array.isArray(cardsData)) return;
      
      // åéŒ²å•†å“ã®ã‚»ãƒƒãƒˆã‚’ä½œæˆ
      const productSet = new Set();
      cardsData.forEach(card => {
        if (card.product && card.product.trim()) {
          // è¤‡æ•°å•†å“ãŒã‚ã‚‹å ´åˆã¯åˆ†å‰²ã—ã¦è¿½åŠ 
          const products = card.product.split(',').map(p => p.trim());
          products.forEach(product => {
            if (product) productSet.add(product);
          });
        }
      });
      
      // ãƒ—ãƒ«ãƒ€ã‚¦ãƒ³ã«ã‚ªãƒ—ã‚·ãƒ§ãƒ³ã‚’è¿½åŠ 
      productSelect.innerHTML = '<option value="">ã™ã¹ã¦ã®å•†å“</option>';
      [...productSet].sort().forEach(product => {
        const option = document.createElement('option');
        option.value = product;
        option.textContent = product;
        productSelect.appendChild(option);
      });
      
      console.log('Initialized product list with', productSet.size, 'products');
    }

    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿
    function loadUserCollection() {
      console.log('Loading user collection from card_list.html format...');
      
      // card_list.htmlå½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’èª­ã¿è¾¼ã¿ï¼ˆ"count_" + cardId ã®å½¢å¼ï¼‰
      userCollection = {};
      let ownedCount = 0;
      let totalStorageItems = 0;
      let validCounts = 0;
      
      // ã™ã¹ã¦ã®localStorageã‚­ãƒ¼ã‚’ãƒã‚§ãƒƒã‚¯
      for (let i = 0; i < localStorage.length; i++) {
        const key = localStorage.key(i);
        if (key && key.startsWith('count_')) {
          totalStorageItems++;
          const value = localStorage.getItem(key);
          console.log(`Found localStorage item: ${key} = ${value}`);
        }
      }
      
      console.log(`Total localStorage items with 'count_' prefix: ${totalStorageItems}`);
      
      if (Array.isArray(cardsData)) {
        console.log('Processing', cardsData.length, 'cards...');
        console.log('First 3 cards from cardsData:', cardsData.slice(0, 3).map(c => ({id: c.id, name: c.name})));
        
        cardsData.forEach((card, index) => {
          const savedCount = localStorage.getItem("count_" + card.id);
          const count = savedCount ? parseInt(savedCount, 10) : 0;
          userCollection[card.id] = count;
          
          if (count > 0) {
            ownedCount++;
            validCounts++;
            if (validCounts <= 5) {  // æœ€åˆã®5æšã®ã¿ãƒ­ã‚°å‡ºåŠ›
              console.log(`Card ${card.id} (${card.name}): count = ${count}`);
            }
          }
          
          // æœ€åˆã®10æšã®è©³ç´°ãƒ­ã‚°
          if (index < 10) {
            console.log(`Debug card ${index}: id=${card.id}, name=${card.name}, savedCount=${savedCount}, count=${count}`);
          }
        });
      } else {
        console.error('cardsData is not an array:', cardsData);
      }
      
      console.log('Loaded userCollection from card_list format:', Object.keys(userCollection).length, 'cards');
      console.log('Total owned card types:', ownedCount);
      console.log('Valid counts found:', validCounts);
      
      // æ‰€æŒã‚«ãƒ¼ãƒ‰æ•°ã‚’è¨ˆç®—
      binderState.ownedCards = ownedCount;
      
      console.log('Final owned cards count:', binderState.ownedCards);
    }
    
    // ãƒ†ã‚¹ãƒˆç”¨ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®ä½œæˆ
    function createTestUserCollection() {
      console.log('Creating test user collection in card_list.html format...');
      
      // æœ€åˆã®10æšã®ã‚«ãƒ¼ãƒ‰ã‚’æ‰€æŒã—ã¦ã„ã‚‹ã“ã¨ã«ã™ã‚‹
      const testCards = cardsData.slice(0, Math.min(10, cardsData.length));
      let addedCount = 0;
      
      testCards.forEach(card => {
        // card_list.htmlå½¢å¼ã§ä¿å­˜
        localStorage.setItem("count_" + card.id, "1");
        userCollection[card.id] = 1;
        addedCount++;
      });
      
      // æ‰€æŒã‚«ãƒ¼ãƒ‰æ•°ã‚’å†è¨ˆç®—
      binderState.ownedCards = addedCount;
      
      console.log('Test user collection created in card_list format');
      console.log('Added cards count:', addedCount);
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é€šçŸ¥
      if (isMobile) {
        showMobileAlert(`ãƒ†ã‚¹ãƒˆç”¨ã«${addedCount}æšã®ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ\nï¼ˆãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ä¸€è¦§ãƒšãƒ¼ã‚¸ã§ã‚‚ç¢ºèªã§ãã¾ã™ï¼‰`, 'âœ…');
      } else {
        alert(`ãƒ†ã‚¹ãƒˆç”¨ã«${addedCount}æšã®ã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸ\nï¼ˆãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ä¸€è¦§ãƒšãƒ¼ã‚¸ã§ã‚‚ç¢ºèªã§ãã¾ã™ï¼‰`);
      }
    }

    // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã®èª­ã¿è¾¼ã¿
    function loadBinderCollection() {
      console.log('Loading binder collection for ID:', binderState.binderId);
      
      const saved = localStorage.getItem('binderCollection');
      console.log('Saved binder collection:', saved);
      
      if (saved) {
        binderCollection = JSON.parse(saved);
      }
      
      console.log('Parsed binder collection:', binderCollection);
      
      // æŒ‡å®šã•ã‚ŒãŸãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’å–å¾—
      binderState.binderData = binderCollection.binders.find(b => b.id == binderState.binderId);
      console.log('Found binder data:', binderState.binderData);
      
      if (!binderState.binderData) {
        console.log('Binder not found, creating test binder');
        // ãƒ†ã‚¹ãƒˆç”¨ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’ä½œæˆ
        const testBinder = {
          id: binderState.binderId,
          name: `ãƒ†ã‚¹ãƒˆãƒã‚¤ãƒ³ãƒ€ãƒ¼ ${binderState.binderId}`,
          description: 'ãƒ†ã‚¹ãƒˆç”¨ãƒã‚¤ãƒ³ãƒ€ãƒ¼',
          layout: {
            type: '3x3',
            rows: 3,
            cols: 3,
            slotsPerPage: 9
          },
          createdAt: new Date().toISOString(),
          updatedAt: new Date().toISOString(),
          pageCount: 1,
          cardCount: 0,
          pages: [{
            id: Date.now(),
            name: 'ãƒšãƒ¼ã‚¸ 1',
            slots: Array(9).fill(null)
          }]
        };
        
        if (!binderCollection.binders) {
          binderCollection.binders = [];
        }
        binderCollection.binders.push(testBinder);
        localStorage.setItem('binderCollection', JSON.stringify(binderCollection));
        binderState.binderData = testBinder;
        console.log('Created test binder:', testBinder);
      }
      
      // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®ãƒšãƒ¼ã‚¸ãƒ‡ãƒ¼ã‚¿ã‚’å¾©å…ƒ
      if (binderState.binderData.pages) {
        binderState.pages = binderState.binderData.pages;
      } else {
        binderState.pages = [createEmptyPage()];
        binderState.binderData.pages = binderState.pages;
      }
      
      // å¤ã„ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã«å¯¾ã—ã¦ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæƒ…å ±ã‚’è¿½åŠ ï¼ˆäº’æ›æ€§ï¼‰
      if (!binderState.binderData.layout) {
        binderState.binderData.layout = {
          type: '3x3',
          rows: 3,
          cols: 3,
          slotsPerPage: 9
        };
        console.log('Added default layout to existing binder');
      }
      
      console.log('Final binder state pages:', binderState.pages);
      
      // ãƒ˜ãƒƒãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã‚’æ›´æ–°
      updateBinderTitle();
    }

    // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®åˆæœŸåŒ–
    function initializeBinder() {
      // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ãŒæ—¢ã«èª­ã¿è¾¼ã¾ã‚Œã¦ã„ã‚‹ã®ã§ã€ç›´æ¥ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
      renderBinder();
    }

    // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚¿ã‚¤ãƒˆãƒ«ã®æ›´æ–°
    function updateBinderTitle() {
      const headerTitle = document.querySelector('.header h1');
      if (binderState.binderData && headerTitle) {
        headerTitle.innerHTML = `ğŸ´ ${binderState.binderData.name}`;
      }
    }

    // ç©ºã®ãƒšãƒ¼ã‚¸ã‚’ä½œæˆ
    function createEmptyPage() {
      const slotsPerPage = binderState.binderData?.layout?.slotsPerPage || 9;
      return {
        id: Date.now(),
        name: `ãƒšãƒ¼ã‚¸ ${binderState.pages.length + 1}`,
        slots: Array(slotsPerPage).fill(null)
      };
    }

    // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderBinder() {
      console.log('renderBinder called');
      console.log('binderState:', binderState);
      console.log('currentPage:', binderState.currentPage);
      
      const container = document.getElementById('binderPages');
      container.innerHTML = '';

      if (binderState.pages.length === 0) {
        binderState.pages = [createEmptyPage()];
      }

      const currentPageData = binderState.pages[binderState.currentPage];
      console.log('currentPageData:', currentPageData);
      
      if (!currentPageData) {
        binderState.currentPage = 0;
        return renderBinder();
      }

      // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæƒ…å ±ã‚’å–å¾—
      const layout = binderState.binderData?.layout || { type: '3x3', cols: 3, slotsPerPage: 9 };
      const slotsPerPage = currentPageData.slots.length;

      // ãƒšãƒ¼ã‚¸ã®ä½œæˆ
      const pageDiv = document.createElement('div');
      pageDiv.className = 'binder-page';
      pageDiv.innerHTML = `
        <div class="page-header">
          <div class="page-title">${currentPageData.name}</div>
          <div class="page-info">
            <span>ãƒšãƒ¼ã‚¸ ${binderState.currentPage + 1} / ${binderState.pages.length}</span>
            <span>é…ç½®æ¸ˆã¿: ${currentPageData.slots.filter(slot => slot !== null).length}/${slotsPerPage}</span>
            <span>ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: ${layout.type}</span>
          </div>
        </div>
        <div class="binder-grid layout-${layout.type}" id="currentPageGrid" style="--grid-cols: ${layout.cols}"></div>
      `;

      container.appendChild(pageDiv);
      renderPageSlots(currentPageData.slots);
      updateStats();
      
      // ãƒšãƒ¼ã‚¸ç•ªå·å…¥åŠ›ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’æ›´æ–°
      updatePageNumberInput();
      
      // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã®UIåˆ¶å¾¡
      updateViewModeUI();
    }

    // ãƒšãƒ¼ã‚¸ã‚¹ãƒ­ãƒƒãƒˆã®ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderPageSlots(slots) {
      const grid = document.getElementById('currentPageGrid');
      grid.innerHTML = '';

      slots.forEach((slotData, index) => {
        const slot = document.createElement('div');
        slot.className = 'card-slot';
        slot.setAttribute('data-slot-index', index);
        
        if (slotData) {
          // ã‚«ãƒ¼ãƒ‰ãŒé…ç½®ã•ã‚Œã¦ã„ã‚‹å ´åˆ
          console.log('Rendering card in slot', index, 'cardId:', slotData.cardId);
          slot.classList.add('occupied');
          const card = cardsData.find(c => c.id === slotData.cardId);
          console.log('Found card:', card);
          
          if (card) {
            const imageUrl = card.cardImageURL || card.image_url || './images/placeholder.png';
            console.log('Card image URL:', imageUrl);
            
            // Sãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®å…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é©ç”¨
            const isShinyRarity = card.rarity === 'S';
            const effectClass = isShinyRarity ? ' s-rarity-effect' : '';
            
            slot.innerHTML = `
              <div class="card-container${effectClass}" draggable="true" data-card-id="${card.id}" data-slot-index="${index}">
                <img src="${imageUrl}" 
                     alt="${card.name}" 
                     class="card-image"
                     onerror="this.src='./images/placeholder.png'">
                <div class="card-overlay">
                  <div class="card-name">${card.name}</div>
                  <div class="card-rarity">${card.rarity || 'Unknown'}</div>
                </div>
              </div>
            `;
            
            // ãƒ‰ãƒ©ãƒƒã‚°ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã‚’è¿½åŠ 
            const cardContainer = slot.querySelector('.card-container');
            if (cardContainer && !binderState.viewMode) {
              cardContainer.addEventListener('dragstart', (e) => handleDragStart(e, index));
              cardContainer.addEventListener('dragend', handleDragEnd);
            }
          } else {
            console.warn('Card not found for id:', slotData.cardId);
            slot.innerHTML = `
              <div class="empty-slot-content">
                <div class="slot-number">${index + 1}</div>
                <div class="slot-action">ã‚«ãƒ¼ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“</div>
              </div>
            `;
          }
        } else {
          // ç©ºã®ã‚¹ãƒ­ãƒƒãƒˆ
          slot.innerHTML = `
            <div class="empty-slot-content">
              <div class="slot-number">${index + 1}</div>
              <div class="slot-action">ã‚¯ãƒªãƒƒã‚¯ã—ã¦ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®</div>
            </div>
          `;
        }

        // ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼ã®è¿½åŠ ï¼ˆç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã®ã¿ï¼‰
        console.log('Adding click listener to slot', index);
        if (!binderState.viewMode) {
          slot.addEventListener('click', () => {
            console.log('Slot clicked:', index);
            openCardSelector(index);
          });
          slot.addEventListener('dragover', handleDragOver);
          slot.addEventListener('dragleave', handleDragLeave);
          slot.addEventListener('drop', (e) => handleDrop(e, index));
        } else {
          // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã§ã¯è¦–è¦šçš„ã«ã‚¯ãƒªãƒƒã‚¯ã§ããªã„ã“ã¨ã‚’ç¤ºã™
          slot.style.cursor = 'default';
        }
        
        grid.appendChild(slot);
      });
    }

    // ã‚«ãƒ¼ãƒ‰é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‹ã
    function openCardSelector(slotIndex) {
      console.log('openCardSelector called with slotIndex:', slotIndex);
      console.log('manualMode status:', binderState.manualMode);
      console.log('cardsData status:', cardsData, 'is array:', Array.isArray(cardsData));
      
      if (!binderState.manualMode) {
        console.log('Manual mode is OFF, showing alert');
        if (isMobile) {
          showMobileAlert('æ‰‹å‹•é…ç½®ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„', 'âš ï¸');
        } else {
          alert('æ‰‹å‹•é…ç½®ãƒ¢ãƒ¼ãƒ‰ã‚’æœ‰åŠ¹ã«ã—ã¦ãã ã•ã„');
        }
        return;
      }

      // cardsDataãŒé…åˆ—ã§ã‚ã‚‹ã“ã¨ã‚’ç¢ºèª
      if (!Array.isArray(cardsData)) {
        console.error('cardsData is not an array:', cardsData);
        if (isMobile) {
          showMobileAlert('ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚', 'â³');
        } else {
          alert('ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
        }
        return;
      }

      currentSlotIndex = slotIndex;
      selectedCardId = null;
      
      // æ‰€æŒã‚«ãƒ¼ãƒ‰ã®ã¿ã‚’è¡¨ç¤º
      availableCards = cardsData.filter(card => userCollection[card.id] > 0);
      console.log('Filtering cards:');
      console.log('Total cards:', cardsData.length);
      console.log('UserCollection sample:', Object.entries(userCollection).slice(0, 5));
      console.log('Cards with count > 0:', Object.entries(userCollection).filter(([id, count]) => count > 0));
      console.log('Available cards:', availableCards.length);
      
      if (availableCards.length === 0) {
        console.log('No available cards found. Debugging...');
        // ãƒ‡ãƒãƒƒã‚°ç”¨ï¼šæœ€åˆã®5æšã®ã‚«ãƒ¼ãƒ‰ã®æ‰€æŒçŠ¶æ³ã‚’ãƒã‚§ãƒƒã‚¯
        const debugCards = cardsData.slice(0, 5);
        debugCards.forEach(card => {
          const count = userCollection[card.id];
          console.log(`Card ${card.id} (${card.name}): stored count = ${count}, localStorage = ${localStorage.getItem("count_" + card.id)}`);
        });
        
        if (isMobile) {
          showMobileAlert('é…ç½®å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“\nãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ä¸€è¦§ãƒšãƒ¼ã‚¸ã§æ‰€æŒæšæ•°ã‚’1ä»¥ä¸Šã«è¨­å®šã—ã¦ãã ã•ã„', 'ğŸ“‹');
        } else {
          alert('é…ç½®å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“\nãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ä¸€è¦§ãƒšãƒ¼ã‚¸ã§æ‰€æŒæšæ•°ã‚’1ä»¥ä¸Šã«è¨­å®šã—ã¦ãã ã•ã„');
        }
        return;
      }

      // ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’è¡¨ç¤º
      const modal = document.getElementById('cardSelectorModal');
      modal.classList.add('show');
      
      // ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ã‚’åˆæœŸåŒ–
      renderCardGrid(availableCards);
      
      // æ¤œç´¢ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã‚’ã‚¯ãƒªã‚¢
      document.getElementById('cardSearchInput').value = '';
      document.getElementById('rarityFilter').value = '';
      document.getElementById('cardTypeFilter').value = '';
      
      // ç¾åœ¨ã®ã‚¹ãƒ­ãƒƒãƒˆã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã€ãã‚Œã‚’é¸æŠçŠ¶æ…‹ã«ã™ã‚‹
      const currentPage = binderState.pages[binderState.currentPage];
      if (currentPage.slots[slotIndex]) {
        selectedCardId = currentPage.slots[slotIndex].cardId;
        highlightSelectedCard();
      }
    }

    // ã‚¹ãƒ­ãƒƒãƒˆã«ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®
    function placeCardInSlot(slotIndex, cardId) {
      console.log('placeCardInSlot called:', slotIndex, cardId);
      const currentPage = binderState.pages[binderState.currentPage];
      console.log('Current page before:', currentPage);
      
      currentPage.slots[slotIndex] = { cardId, placedAt: Date.now() };
      console.log('Current page after:', currentPage);
      console.log('Slot data:', currentPage.slots[slotIndex]);
      
      saveBinder();
      renderBinder();
    }

    // ã‚«ãƒ¼ãƒ‰ã‚°ãƒªãƒƒãƒ‰ã‚’ãƒ¬ãƒ³ãƒ€ãƒªãƒ³ã‚°
    function renderCardGrid(cards) {
      console.log('renderCardGrid called with', cards.length, 'cards');
      const cardGrid = document.getElementById('cardGrid');
      cardGrid.innerHTML = '';

      cards.forEach((card, index) => {
        console.log(`Rendering card ${index}:`, card.id, card.name);
        const cardItem = document.createElement('div');
        
        // Sãƒ¬ã‚¢ãƒªãƒ†ã‚£ã®å…‰ã‚¨ãƒ•ã‚§ã‚¯ãƒˆã‚’é©ç”¨
        const isShinyRarity = card.rarity === 'S';
        cardItem.className = isShinyRarity ? 'card-item s-rarity-effect' : 'card-item';
        cardItem.setAttribute('data-card-id', card.id);
        
        cardItem.innerHTML = `
          <img src="${card.cardImageURL || './images/placeholder.png'}" 
               alt="${card.name}" 
               onerror="this.src='./images/placeholder.png'">
          <div class="card-info">
            <div class="name">${card.name}</div>
            <div class="rarity rarity-${card.rarity || 'C'}">${card.rarity || 'C'}</div>
          </div>
        `;
        
        console.log(`Adding click listener for card:`, card.id);
        cardItem.addEventListener('click', () => {
          console.log('Card clicked at:', new Date().toISOString(), 'cardId:', card.id);
          selectCard(card.id);
        });
        cardGrid.appendChild(cardItem);
      });
      console.log('renderCardGrid completed, total cards rendered:', cards.length);
    }

    // ä¸€æ™‚çš„ãªãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
    function showTemporaryMessage(message, type = 'info') {
      const messageDiv = document.createElement('div');
      messageDiv.className = `temporary-message ${type}`;
      messageDiv.textContent = message;
      messageDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: ${type === 'success' ? '#4CAF50' : type === 'error' ? '#f44336' : '#2196F3'};
        color: white;
        padding: 15px 25px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: bold;
        z-index: 10000;
        box-shadow: 0 4px 12px rgba(0,0,0,0.3);
        animation: fadeInOut 2s ease-in-out;
      `;
      
      document.body.appendChild(messageDiv);
      
      setTimeout(() => {
        if (messageDiv.parentNode) {
          messageDiv.parentNode.removeChild(messageDiv);
        }
      }, 2000);
    }

    // ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ
    function selectCard(cardId) {
      console.log('selectCard called with cardId:', cardId);
      
      // æ—¢ã«åŒã˜ã‚«ãƒ¼ãƒ‰ãŒé¸æŠã•ã‚Œã¦ã„ã‚‹å ´åˆã¯ä½•ã‚‚ã—ãªã„
      if (selectedCardId === cardId) {
        console.log('Same card already selected, ignoring');
        return;
      }
      
      selectedCardId = cardId;
      console.log('selectedCardId set to:', selectedCardId);
      highlightSelectedCard();
    }

    // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
    function highlightSelectedCard() {
      // ã™ã¹ã¦ã®ã‚«ãƒ¼ãƒ‰ã‹ã‚‰é¸æŠçŠ¶æ…‹ã‚’å‰Šé™¤
      document.querySelectorAll('.card-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      if (selectedCardId) {
        const selectedItem = document.querySelector(`[data-card-id="${selectedCardId}"]`);
        if (selectedItem) {
          selectedItem.classList.add('selected');
        }
      }
    }

    // ã‚«ãƒ¼ãƒ‰ã‚’æ¤œç´¢ãƒ»ãƒ•ã‚£ãƒ«ã‚¿ãƒªãƒ³ã‚°
    function filterCards() {
      const searchTerm = document.getElementById('cardSearchInput').value.toLowerCase();
      const rarityFilter = document.getElementById('rarityFilter').value;
      const cardTypeFilter = document.getElementById('cardTypeFilter').value;
      
      const filteredCards = availableCards.filter(card => {
        const matchesSearch = card.name.toLowerCase().includes(searchTerm);
        const matchesRarity = !rarityFilter || card.rarity === rarityFilter;
        
        // ã‚«ãƒ¼ãƒ‰ã‚¿ã‚¤ãƒ—ã®ãƒãƒƒãƒãƒ³ã‚°ï¼ˆéƒ¨åˆ†ãƒãƒƒãƒã§å¯¾å¿œï¼‰
        const matchesCardType = !cardTypeFilter || 
          (card.card_type && card.card_type.includes(cardTypeFilter));
        
        return matchesSearch && matchesRarity && matchesCardType;
      });
      
      renderCardGrid(filteredCards);
      highlightSelectedCard();
    }

    // é¸æŠã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’é…ç½®
    function placeSelectedCard() {
      console.log('placeSelectedCard called at:', new Date().toISOString(), {
        selectedCardId,
        currentSlotIndex,
        typeOfSelectedCardId: typeof selectedCardId,
        typeOfCurrentSlotIndex: typeof currentSlotIndex,
        hasValidData: selectedCardId && currentSlotIndex !== null
      });
      
      if (selectedCardId && currentSlotIndex !== null) {
        console.log('Placing card:', selectedCardId, 'in slot:', currentSlotIndex);
        
        // ã‚«ãƒ¼ãƒ‰åã‚’å–å¾—ã—ã¦è¡¨ç¤º
        const card = cardsData.find(c => c.id === selectedCardId);
        const cardName = card ? card.name : selectedCardId;
        
        placeCardInSlot(currentSlotIndex, selectedCardId);
        
        // é…ç½®å®Œäº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã‚’è¡¨ç¤º
        if (isMobile) {
          showMobileAlert(`ã€Œ${cardName}ã€ã‚’é…ç½®ã—ã¾ã—ãŸï¼`, 'âœ…');
        } else {
          showTemporaryMessage(`ã€Œ${cardName}ã€ã‚’é…ç½®ã—ã¾ã—ãŸï¼`, 'success');
        }
        
        closeCardSelector();
      } else {
        console.warn('Invalid data for placing card:', { selectedCardId, currentSlotIndex });
        
        if (!selectedCardId) {
          if (isMobile) {
            showMobileAlert('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„', 'âš ï¸');
          } else {
            alert('ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„');
          }
        }
      }
    }

    // ã‚«ãƒ¼ãƒ‰ã‚’ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰å‰Šé™¤
    function removeCardFromSlot() {
      if (currentSlotIndex !== null) {
        const currentPage = binderState.pages[binderState.currentPage];
        currentPage.slots[currentSlotIndex] = null;
        saveBinder();
        renderBinder();
        closeCardSelector();
      }
    }

    // ã‚«ãƒ¼ãƒ‰é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
    function closeCardSelector() {
      const modal = document.getElementById('cardSelectorModal');
      modal.classList.remove('show');
      currentSlotIndex = null;
      selectedCardId = null;
    }

    // è‡ªå‹•é…ç½®
    function autoArrange(mode) {
      if (!Array.isArray(cardsData)) {
        alert('ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ã®èª­ã¿è¾¼ã¿ä¸­ã§ã™ã€‚ã—ã°ã‚‰ããŠå¾…ã¡ãã ã•ã„ã€‚');
        return;
      }
      
      // é †åºè¨­å®šã‚’å–å¾—
      const sortOrder = document.getElementById('sortOrderSelect').value;
      const secondarySort = document.getElementById('secondarySortSelect').value;
      const productFilter = document.getElementById('productSelect').value;
      const preserveEmptySlots = document.getElementById('preserveEmptySlots').checked;
      const isAscending = sortOrder === 'asc';
      
      // å¯¾è±¡ã‚«ãƒ¼ãƒ‰ã‚’ãƒ•ã‚£ãƒ«ã‚¿
      let filteredCards = [...cardsData];
      
      if (productFilter) {
        filteredCards = filteredCards.filter(card => 
          card.product && card.product.includes(productFilter)
        );
      }
      
      if (filteredCards.length === 0) {
        const message = productFilter 
          ? `åéŒ²å•†å“ã€Œ${productFilter}ã€ã®ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“`
          : 'ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“';
        alert(message);
        return;
      }

      // ã‚½ãƒ¼ãƒˆæ–¹æ³•ã‚’é¸æŠï¼ˆäºŒæ¬¡ã‚½ãƒ¼ãƒˆå¯¾å¿œï¼‰
      let sortedCards = [...filteredCards];
      
      // äºŒæ¬¡ã‚½ãƒ¼ãƒˆé–¢æ•°ã‚’å®šç¾©
      const applySortingLogic = (cards, primaryMode, secondaryMode, ascending) => {
        return cards.sort((a, b) => {
          // ãƒ—ãƒ©ã‚¤ãƒãƒªã‚½ãƒ¼ãƒˆ
          let diff = 0;
          switch(primaryMode) {
            case 'rarity':
              const rarityRank = { 
                "SEC": 14, "OUR": 13, "UR": 12, "SY": 11, "OSR": 10, 
                "SR": 9, "P": 8, "S": 7, "OC": 6, "RR": 5, 
                "R": 4, "U": 3, "C": 2, "â€": 1, "-": 1 
              };
              diff = (rarityRank[b.rarity] || 0) - (rarityRank[a.rarity] || 0);
              break;
            case 'series':
              diff = (a.expansion || '').localeCompare(b.expansion || '');
              break;
            case 'product':
              diff = (a.product || '').localeCompare(b.product || '');
              break;
            case 'collection':
              diff = (userCollection[b.id] || 0) - (userCollection[a.id] || 0);
              break;
            case 'release':
              diff = new Date(b.releaseDate || 0) - new Date(a.releaseDate || 0);
              break;
            case 'custom':
              diff = a.name.localeCompare(b.name);
              break;
          }
          
          // åŒã˜å€¤ã®å ´åˆã¯äºŒæ¬¡ã‚½ãƒ¼ãƒˆã‚’é©ç”¨
          if (diff === 0 && secondaryMode) {
            switch(secondaryMode) {
              case 'cardId':
                diff = (a.id || '').localeCompare(b.id || '');
                break;
              case 'release':
                diff = new Date(a.releaseDate || 0) - new Date(b.releaseDate || 0);
                break;
              case 'name':
                diff = a.name.localeCompare(b.name);
                break;
              case 'product':
                diff = (a.product || '').localeCompare(b.product || '');
                break;
            }
          }
          
          return ascending ? diff : -diff;
        });
      };
      
      sortedCards = applySortingLogic(sortedCards, mode, secondarySort, isAscending);

      // ç©ºã‚¹ãƒ­ãƒƒãƒˆä¿æŒãƒ¢ãƒ¼ãƒ‰ã®å ´åˆ
      if (preserveEmptySlots) {
        // æŒã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã®ã¿ã«çµã‚Šè¾¼ã¿
        const ownedCards = sortedCards.filter(card => userCollection[card.id] > 0);
        
        // å…ƒã®ã‚½ãƒ¼ãƒˆé †ã‚’ä¿æŒã—ãŸã¾ã¾ã€æŒã£ã¦ã„ãªã„ã‚«ãƒ¼ãƒ‰ã®ä½ç½®ã« null ã‚’æŒ¿å…¥
        const finalCards = [];
        for (const card of sortedCards) {
          if (userCollection[card.id] > 0) {
            finalCards.push(card);
          } else {
            finalCards.push(null); // ç©ºã‚¹ãƒ­ãƒƒãƒˆ
          }
        }
        sortedCards = finalCards;
      } else {
        // é€šå¸¸ãƒ¢ãƒ¼ãƒ‰ï¼šæŒã£ã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ã®ã¿
        sortedCards = sortedCards.filter(card => userCollection[card.id] > 0);
      }

      if (sortedCards.filter(card => card !== null).length === 0) {
        const message = productFilter 
          ? `åéŒ²å•†å“ã€Œ${productFilter}ã€ã®é…ç½®å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“`
          : 'é…ç½®å¯èƒ½ãªã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“';
        alert(message);
        return;
      }

      // ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆæƒ…å ±ã‚’å–å¾—
      const layout = binderState.binderData?.layout || { slotsPerPage: 9 };
      const slotsPerPage = layout.slotsPerPage;

      // å¿…è¦ãªãƒšãƒ¼ã‚¸æ•°ã‚’è¨ˆç®—
      const requiredPages = Math.ceil(sortedCards.length / slotsPerPage);
      
      // ãƒšãƒ¼ã‚¸ã‚’è¿½åŠ /èª¿æ•´
      while (binderState.pages.length < requiredPages) {
        binderState.pages.push(createEmptyPage());
      }

      // ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®
      let cardIndex = 0;
      for (let pageIndex = 0; pageIndex < requiredPages && cardIndex < sortedCards.length; pageIndex++) {
        const page = binderState.pages[pageIndex];
        page.slots = Array(slotsPerPage).fill(null);
        
        for (let slotIndex = 0; slotIndex < slotsPerPage && cardIndex < sortedCards.length; slotIndex++) {
          const card = sortedCards[cardIndex];
          if (card) {
            page.slots[slotIndex] = {
              cardId: card.id,
              placedAt: Date.now(),
              autoArranged: true
            };
          } else {
            page.slots[slotIndex] = null; // ç©ºã‚¹ãƒ­ãƒƒãƒˆä¿æŒ
          }
          cardIndex++;
        }
      }

      binderState.currentPage = 0;
      saveBinder();
      renderBinder();
      hideAutoArrangePanel();
      
      const modeNames = {
        'rarity': 'ãƒ¬ã‚¢ãƒªãƒ†ã‚£',
        'series': 'ã‚·ãƒªãƒ¼ã‚º',
        'product': 'åéŒ²å•†å“',
        'collection': 'æ‰€æŒæšæ•°',
        'release': 'ç™ºå£²æ—¥',
        'custom': 'ã‚«ã‚¹ã‚¿ãƒ '
      };
      
      const secondaryNames = {
        'cardId': 'ã‚«ãƒ¼ãƒ‰ç•ªå·',
        'release': 'ç™ºå£²æ—¥',
        'name': 'åå‰',
        'product': 'åéŒ²å•†å“'
      };
      
      const layoutName = layout.type || '3x3';
      const placedCards = sortedCards.filter(card => card !== null).length;
      const emptySlots = preserveEmptySlots ? sortedCards.filter(card => card === null).length : 0;
      const orderText = isAscending ? 'æ˜‡é †' : 'é™é †';
      const productText = productFilter ? ` (${productFilter})` : '';
      const secondaryText = secondarySort ? ` â†’ ${secondaryNames[secondarySort]}é †` : '';
      const emptyText = emptySlots > 0 ? ` (ç©ºã‚¹ãƒ­ãƒƒãƒˆ${emptySlots}å€‹ä¿æŒ)` : '';
      
      let message = `${modeNames[mode] || mode}é †${orderText}${secondaryText}ã§${placedCards}æšã®ã‚«ãƒ¼ãƒ‰ã‚’é…ç½®ã—ã¾ã—ãŸï¼${productText}${emptyText}\nãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆ: ${layoutName} (${slotsPerPage}æš/ãƒšãƒ¼ã‚¸)`;
      
      if (isMobile) {
        showMobileAlert(message, 'âœ…');
      } else {
        alert(message);
      }
    }

    // çµ±è¨ˆã®æ›´æ–°
    function updateStats() {
      // çµ±è¨ˆè¡¨ç¤ºã¯å‰Šé™¤ã•ã‚ŒãŸãŸã‚ã€ãƒšãƒ¼ã‚¸æƒ…å ±ã®ã¿æ›´æ–°
      const currentPage = binderState.pages[binderState.currentPage];
      const filledSlots = currentPage ? currentPage.slots.filter(slot => slot !== null).length : 0;
      
      // ãƒšãƒ¼ã‚¸æƒ…å ±ã‚’ãƒšãƒ¼ã‚¸ãƒ˜ãƒƒãƒ€ãƒ¼ã«åæ˜ 
      const pageInfo = document.querySelector('.page-info');
      if (pageInfo) {
        pageInfo.innerHTML = `
          <span>ãƒšãƒ¼ã‚¸ ${binderState.currentPage + 1} / ${binderState.pages.length}</span>
          <span>é…ç½®æ¸ˆã¿: ${filledSlots}/9</span>
        `;
      }
    }

    // ãƒ¦ãƒ¼ãƒ†ã‚£ãƒªãƒ†ã‚£é–¢æ•°
    function toggleTheme() {
      document.body.classList.toggle('dark');
      localStorage.setItem('darkMode', document.body.classList.contains('dark'));
    }

    function showAutoArrangePanel() {
      const panel = document.getElementById('autoArrangePanel');
      panel.style.display = panel.style.display === 'none' ? 'block' : 'none';
      binderState.autoArrangeVisible = panel.style.display === 'block';
    }

    function hideAutoArrangePanel() {
      document.getElementById('autoArrangePanel').style.display = 'none';
      binderState.autoArrangeVisible = false;
    }

    function toggleManualMode() {
      console.log('toggleManualMode called, current state:', binderState.manualMode);
      binderState.manualMode = !binderState.manualMode;
      console.log('toggleManualMode new state:', binderState.manualMode);
      const btn = document.getElementById('manualModeBtn');
      if (binderState.manualMode) {
        btn.classList.add('active');
        btn.textContent = 'âœ‹';
        btn.title = 'æ‰‹å‹•é…ç½®ãƒ¢ãƒ¼ãƒ‰ ON';
      } else {
        btn.classList.remove('active');
        btn.textContent = 'âœ‹';
        btn.title = 'æ‰‹å‹•é…ç½®ãƒ¢ãƒ¼ãƒ‰ OFF';
      }
    }

    function addTestCards() {
      if (!Array.isArray(cardsData) || cardsData.length === 0) {
        alert('ã‚«ãƒ¼ãƒ‰ãƒ‡ãƒ¼ã‚¿ãŒèª­ã¿è¾¼ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
        return;
      }
      
      const currentOwnedCount = binderState.ownedCards;
      createTestUserCollection();
      
      // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³ã‚’å†èª­ã¿è¾¼ã¿
      loadUserCollection();
      
      if (binderState.ownedCards > currentOwnedCount) {
        alert(`${binderState.ownedCards - currentOwnedCount}æšã®ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã‚’è¿½åŠ ã—ã¾ã—ãŸï¼\nãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ä¸€è¦§ãƒšãƒ¼ã‚¸ã§ã‚‚ç¢ºèªã§ãã¾ã™ã€‚`);
      } else {
        alert('ãƒ†ã‚¹ãƒˆã‚«ãƒ¼ãƒ‰ã¯æ—¢ã«è¿½åŠ æ¸ˆã¿ã§ã™ã€‚');
      }
    }

    function previousPage() {
      if (binderState.currentPage > 0) {
        binderState.currentPage--;
        renderBinder();
        updatePageNumberInput();
      }
    }

    function nextPage() {
      if (binderState.currentPage < binderState.pages.length - 1) {
        binderState.currentPage++;
        renderBinder();
        updatePageNumberInput();
      }
    }

    function addNewPage() {
      binderState.pages.push(createEmptyPage());
      binderState.currentPage = binderState.pages.length - 1;
      saveBinder();
      renderBinder();
      updatePageNumberInput();
    }

    function saveBinder() {
      console.log('saveBinder called');
      console.log('binderState.binderData:', binderState.binderData);
      
      if (binderState.binderData) {
        // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ‡ãƒ¼ã‚¿ã‚’æ›´æ–°
        binderState.binderData.pages = binderState.pages;
        binderState.binderData.pageCount = binderState.pages.length;
        binderState.binderData.cardCount = binderState.pages.reduce((count, page) => {
          return count + page.slots.filter(slot => slot !== null).length;
        }, 0);
        binderState.binderData.updatedAt = new Date().toISOString();
        
        console.log('Updated binder data:', binderState.binderData);
        console.log('Card count:', binderState.binderData.cardCount);
        
        // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚³ãƒ¬ã‚¯ã‚·ãƒ§ãƒ³å…¨ä½“ã‚’ä¿å­˜
        localStorage.setItem('binderCollection', JSON.stringify(binderCollection));
        console.log('Saved to localStorage');
      } else {
        console.warn('No binderData to save');
      }
    }

    function saveBinderLayout() {
      saveBinder();
      alert('ãƒã‚¤ãƒ³ãƒ€ãƒ¼ãƒ¬ã‚¤ã‚¢ã‚¦ãƒˆã‚’ä¿å­˜ã—ã¾ã—ãŸï¼');
    }

    function goHome() {
      // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ä¸€è¦§ã«æˆ»ã‚‹
      window.location.href = 'binder_collection.html';
    }

    // ãƒ‰ãƒ©ãƒƒã‚°&ãƒ‰ãƒ­ãƒƒãƒ—ã®å‡¦ç†
    let draggedCardData = null;
    let draggedFromSlot = null;

    function handleDragStart(e, slotIndex) {
      console.log('Drag started from slot:', slotIndex);
      const currentPage = binderState.pages[binderState.currentPage];
      const slotData = currentPage.slots[slotIndex];
      
      if (slotData) {
        draggedCardData = {
          cardId: slotData.cardId,
          fromSlot: slotIndex,
          fromPage: binderState.currentPage
        };
        draggedFromSlot = slotIndex;
        
        // ãƒ‰ãƒ©ãƒƒã‚°åŠ¹æœã‚’è¨­å®š
        e.currentTarget.classList.add('dragging');
        e.currentTarget.style.opacity = '0.5';
        
        // ãƒ‡ãƒ¼ã‚¿è»¢é€ã‚’è¨­å®š
        e.dataTransfer.setData('text/plain', JSON.stringify(draggedCardData));
        e.dataTransfer.effectAllowed = 'move';
        
        console.log('Dragging card:', draggedCardData);
      }
    }

    function handleDragEnd(e) {
      console.log('Drag ended');
      e.currentTarget.classList.remove('dragging');
      e.currentTarget.style.opacity = '1';
      
      // ãƒ‰ãƒ©ãƒƒã‚°ã‚ªãƒ¼ãƒãƒ¼åŠ¹æœã‚’ã™ã¹ã¦ã®ã‚¹ãƒ­ãƒƒãƒˆã‹ã‚‰å‰Šé™¤
      document.querySelectorAll('.card-slot.drag-over').forEach(slot => {
        slot.classList.remove('drag-over');
      });
      
      draggedCardData = null;
      draggedFromSlot = null;
    }

    function handleDragOver(e) {
      e.preventDefault();
      e.dataTransfer.dropEffect = 'move';
      
      // ãƒ‰ãƒ©ãƒƒã‚°å…ƒã¨åŒã˜ã‚¹ãƒ­ãƒƒãƒˆã§ãªã„å ´åˆã®ã¿ãƒã‚¤ãƒ©ã‚¤ãƒˆ
      const slotIndex = parseInt(e.currentTarget.dataset.slotIndex);
      if (draggedFromSlot !== slotIndex) {
        e.currentTarget.classList.add('drag-over');
      }
    }

    function handleDragLeave(e) {
      e.currentTarget.classList.remove('drag-over');
    }

    function handleDrop(e, slotIndex) {
      e.preventDefault();
      e.currentTarget.classList.remove('drag-over');
      
      console.log('Drop at slot:', slotIndex);
      
      if (!draggedCardData) {
        console.log('No dragged card data');
        return;
      }
      
      // åŒã˜ã‚¹ãƒ­ãƒƒãƒˆã¸ã®ãƒ‰ãƒ­ãƒƒãƒ—ã¯ç„¡è¦–
      if (draggedCardData.fromSlot === slotIndex && draggedCardData.fromPage === binderState.currentPage) {
        console.log('Dropped on same slot, ignoring');
        return;
      }
      
      const currentPage = binderState.pages[binderState.currentPage];
      const targetSlot = currentPage.slots[slotIndex];
      const sourceSlot = currentPage.slots[draggedCardData.fromSlot];
      
      // ã‚«ãƒ¼ãƒ‰ã®ç§»å‹•å‡¦ç†
      if (targetSlot) {
        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¹ãƒ­ãƒƒãƒˆã«ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚‹å ´åˆã¯å…¥ã‚Œæ›¿ãˆ
        console.log('Swapping cards between slots', draggedCardData.fromSlot, 'and', slotIndex);
        currentPage.slots[draggedCardData.fromSlot] = targetSlot;
        currentPage.slots[slotIndex] = sourceSlot;
      } else {
        // ã‚¿ãƒ¼ã‚²ãƒƒãƒˆã‚¹ãƒ­ãƒƒãƒˆãŒç©ºã®å ´åˆã¯ç§»å‹•
        console.log('Moving card from slot', draggedCardData.fromSlot, 'to slot', slotIndex);
        currentPage.slots[slotIndex] = sourceSlot;
        currentPage.slots[draggedCardData.fromSlot] = null;
      }
      
      // ãƒã‚¤ãƒ³ãƒ€ãƒ¼ã‚’ä¿å­˜ã—ã¦å†æç”»
      saveBinder();
      renderBinder();
      
      // æˆåŠŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      if (isMobile) {
        showMobileAlert('ã‚«ãƒ¼ãƒ‰ã‚’ç§»å‹•ã—ã¾ã—ãŸï¼', 'âœ…');
      } else {
        console.log('Card moved successfully');
      }
    }

    // ãƒ€ãƒ¼ã‚¯ãƒ¢ãƒ¼ãƒ‰ã®å¾©å…ƒ
    if (localStorage.getItem('darkMode') === 'true') {
      document.body.classList.add('dark');
    }

    // ãƒ¢ãƒã‚¤ãƒ«ç”¨æ©Ÿèƒ½ã®åˆæœŸåŒ–
    function initializeMobileFeatures() {
      isMobile = window.innerWidth <= 768;
      
      // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¸ã‚§ã‚¹ãƒãƒ£ãƒ¼ã®è¨­å®š
      const binderContainer = document.querySelector('.binder-container');
      if (binderContainer && isMobile) {
        binderContainer.addEventListener('touchstart', handleTouchStart, { passive: false });
        binderContainer.addEventListener('touchend', handleTouchEnd, { passive: false });
      }
      
      // ãƒªã‚µã‚¤ã‚ºã‚¤ãƒ™ãƒ³ãƒˆ
      window.addEventListener('resize', () => {
        isMobile = window.innerWidth <= 768;
      });
    }

    // ã‚¿ãƒƒãƒé–‹å§‹
    function handleTouchStart(e) {
      touchStartX = e.touches[0].clientX;
      touchStartY = e.touches[0].clientY;
    }

    // ã‚¿ãƒƒãƒçµ‚äº†ï¼ˆã‚¹ãƒ¯ã‚¤ãƒ—æ¤œå‡ºï¼‰
    function handleTouchEnd(e) {
      if (!touchStartX || !touchStartY) return;
      
      const touchEndX = e.changedTouches[0].clientX;
      const touchEndY = e.changedTouches[0].clientY;
      
      const diffX = touchStartX - touchEndX;
      const diffY = touchStartY - touchEndY;
      
      // æ°´å¹³ã‚¹ãƒ¯ã‚¤ãƒ—ã®æ¤œå‡ºï¼ˆç¸¦ã®ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ã‚’å¦¨ã’ãªã„ã‚ˆã†ã«ï¼‰
      if (Math.abs(diffX) > Math.abs(diffY) && Math.abs(diffX) > 50) {
        if (diffX > 0) {
          // å·¦ã‚¹ãƒ¯ã‚¤ãƒ— - æ¬¡ã®ãƒšãƒ¼ã‚¸
          nextPage();
          showSwipeIndicator('æ¬¡ã®ãƒšãƒ¼ã‚¸ â†’');
        } else {
          // å³ã‚¹ãƒ¯ã‚¤ãƒ— - å‰ã®ãƒšãƒ¼ã‚¸
          previousPage();
          showSwipeIndicator('â† å‰ã®ãƒšãƒ¼ã‚¸');
        }
      }
      
      touchStartX = 0;
      touchStartY = 0;
    }

    // ã‚¹ãƒ¯ã‚¤ãƒ—ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼è¡¨ç¤º
    function showSwipeIndicator(message) {
      const indicator = document.getElementById('swipeIndicator');
      indicator.textContent = message;
      indicator.classList.add('show');
      setTimeout(() => {
        indicator.classList.remove('show');
      }, 1500);
    }

    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚¢ãƒ©ãƒ¼ãƒˆ
    function showMobileAlert(message, icon = 'ğŸ“±') {
      const alertDiv = document.createElement('div');
      alertDiv.style.cssText = `
        position: fixed;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        background: rgba(0,0,0,0.9);
        color: white;
        padding: 20px 30px;
        border-radius: 15px;
        z-index: 10000;
        text-align: center;
        font-size: 1.1em;
        max-width: 80vw;
        box-shadow: 0 8px 32px rgba(0,0,0,0.5);
      `;
      alertDiv.innerHTML = `<div style="font-size: 1.5em; margin-bottom: 10px;">${icon}</div>${message}`;
      
      document.body.appendChild(alertDiv);
      
      setTimeout(() => {
        alertDiv.remove();
      }, 2500);
    }

    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ã‚«ãƒ¼ãƒ‰ã‚»ãƒ¬ã‚¯ã‚¿ãƒ¼
    function showMobileCardSelector(slotIndex, ownedCards) {
      const modal = document.createElement('div');
      modal.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0,0,0,0.8);
        z-index: 10000;
        overflow-y: auto;
        padding: 20px;
        box-sizing: border-box;
      `;
      
      const content = document.createElement('div');
      content.style.cssText = `
        background: white;
        border-radius: 15px;
        padding: 20px;
        max-width: 500px;
        margin: 0 auto;
        color: #333;
      `;
      
      content.innerHTML = `
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
          <h3 style="margin: 0;">ã‚«ãƒ¼ãƒ‰ã‚’é¸æŠ</h3>
          <button onclick="this.closest('.modal').remove()" style="background: none; border: none; font-size: 1.5em; cursor: pointer;">âœ•</button>
        </div>
        <div style="display: grid; grid-template-columns: repeat(auto-fill, minmax(80px, 1fr)); gap: 10px; max-height: 60vh; overflow-y: auto;">
          ${ownedCards.map((card, index) => `
            <div onclick="selectCard(${slotIndex}, '${card.id}'); this.closest('.modal').remove();" 
                 style="border: 2px solid #ddd; border-radius: 8px; padding: 8px; cursor: pointer; text-align: center; font-size: 0.8em;">
              <img src="${card.cardImageURL || './images/placeholder.png'}" 
                   style="width: 100%; height: 60px; object-fit: cover; border-radius: 4px; margin-bottom: 5px;"
                   onerror="this.src='./images/placeholder.png'">
              <div style="font-weight: bold; line-height: 1.2;">${card.name}</div>
              <div style="color: #666; font-size: 0.9em;">${card.rarity || 'Unknown'}</div>
            </div>
          `).join('')}
        </div>
      `;
      
      modal.className = 'modal';
      modal.appendChild(content);
      document.body.appendChild(modal);
    }

    // ãƒ¢ãƒã‚¤ãƒ«ç”¨ãƒ¡ãƒ‹ãƒ¥ãƒ¼åˆ‡ã‚Šæ›¿ãˆ
    function toggleMobileMenu() {
      mobileMenuVisible = !mobileMenuVisible;
      const fab = document.getElementById('mobileFab');
      
      if (mobileMenuVisible) {
        fab.textContent = 'âœ•';
        fab.style.background = 'linear-gradient(45deg, #dc3545, #c82333)';
        showAutoArrangePanel();
      } else {
        fab.textContent = 'âš™ï¸';
        fab.style.background = 'linear-gradient(45deg, #667eea, #764ba2)';
        hideAutoArrangePanel();
      }
    }

    // ãƒ¢ãƒ¼ãƒ€ãƒ«é–¢é€£ã®ã‚¤ãƒ™ãƒ³ãƒˆãƒªã‚¹ãƒŠãƒ¼
    document.addEventListener('DOMContentLoaded', function() {
      // ãƒ¢ãƒ¼ãƒ€ãƒ«å¤–ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ãŸæ™‚ã®å‡¦ç†
      document.addEventListener('click', function(e) {
        if (e.target.classList.contains('modal-backdrop')) {
          closeCardSelector();
        }
      });

      // ESCã‚­ãƒ¼ã§ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      document.addEventListener('keydown', function(e) {
        if (e.key === 'Escape') {
          closeCardSelector();
        }
      });

      // ã‚«ãƒ¼ãƒ‰é¸æŠæ™‚ã®ãƒ€ãƒ–ãƒ«ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
      document.addEventListener('dblclick', function(e) {
        if (e.target.closest('.card-item')) {
          placeSelectedCard();
        }
      });
    });
    // é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã®UIæ›´æ–°
    function updateViewModeUI() {
      // ç·¨é›†é–¢é€£ãƒœã‚¿ãƒ³ã®è¡¨ç¤º/éè¡¨ç¤ºåˆ¶å¾¡
      const editElements = [
        document.getElementById('manualModeBtn'),
        document.querySelector('[onclick="showAutoArrangePanel()"]'),
        document.querySelector('[onclick="addTestCards()"]'),
        document.querySelector('[onclick="saveBinderLayout()"]'),
        document.getElementById('clearBtn'),
        document.querySelector('[onclick="addNewPage()"]')
      ];
      
      editElements.forEach(element => {
        if (element) {
          element.style.display = binderState.viewMode ? 'none' : 'inline-block';
        }
      });
      
      // è‡ªå‹•é…ç½®ãƒ‘ãƒãƒ«ã‚’é–‰ã˜ã‚‹
      if (binderState.viewMode && binderState.autoArrangeVisible) {
        hideAutoArrangePanel();
      }
      
      // ã‚«ãƒ¼ãƒ‰é¸æŠãƒ¢ãƒ¼ãƒ€ãƒ«ã‚’é–‰ã˜ã‚‹
      if (binderState.viewMode) {
        closeCardSelector();
      }
    }

    // ãƒšãƒ¼ã‚¸ãƒŠãƒ“ã‚²ãƒ¼ã‚·ãƒ§ãƒ³æ‹¡å¼µæ©Ÿèƒ½
    function goToFirstPage() {
      if (binderState.pages.length > 0) {
        binderState.currentPage = 0;
        renderBinder();
        updatePageNumberInput();
      }
    }

    function goToLastPage() {
      if (binderState.pages.length > 0) {
        binderState.currentPage = binderState.pages.length - 1;
        renderBinder();
        updatePageNumberInput();
      }
    }

    function goToPage() {
      const input = document.getElementById('pageNumberInput');
      const pageNumber = parseInt(input.value);
      
      if (isNaN(pageNumber) || pageNumber < 1 || pageNumber > binderState.pages.length) {
        if (isMobile) {
          showMobileAlert(`1ã‹ã‚‰${binderState.pages.length}ã®é–“ã®ãƒšãƒ¼ã‚¸ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`, 'âš ï¸');
        } else {
          alert(`1ã‹ã‚‰${binderState.pages.length}ã®é–“ã®ãƒšãƒ¼ã‚¸ç•ªå·ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„`);
        }
        return;
      }
      
      binderState.currentPage = pageNumber - 1;
      renderBinder();
      updatePageNumberInput();
    }

    function updatePageNumberInput() {
      const input = document.getElementById('pageNumberInput');
      if (input) {
        input.value = binderState.currentPage + 1;
        input.max = binderState.pages.length;
      }
    }

    // é–²è¦§/ç·¨é›†ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
    function toggleViewMode() {
      binderState.viewMode = !binderState.viewMode;
      const btn = document.getElementById('viewModeBtn');
      
      if (binderState.viewMode) {
        btn.textContent = 'âœï¸ ç·¨é›†ãƒ¢ãƒ¼ãƒ‰';
        btn.title = 'ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿';
        if (isMobile) {
          showMobileAlert('é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ', 'â„¹ï¸');
        }
      } else {
        btn.textContent = 'ğŸ‘ï¸ é–²è¦§ãƒ¢ãƒ¼ãƒ‰';
        btn.title = 'é–²è¦§ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡æ›¿';
        if (isMobile) {
          showMobileAlert('ç·¨é›†ãƒ¢ãƒ¼ãƒ‰ã«åˆ‡ã‚Šæ›¿ãˆã¾ã—ãŸ', 'â„¹ï¸');
        }
      }
      
      renderBinder();
    }

    // å…¨ã‚«ãƒ¼ãƒ‰åˆæœŸåŒ–
    function clearAllCards() {
      const totalCards = binderState.pages.reduce((count, page) => {
        return count + page.slots.filter(slot => slot !== null).length;
      }, 0);
      
      if (totalCards === 0) {
        if (isMobile) {
          showMobileAlert('é…ç½®ã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“', 'â„¹ï¸');
        } else {
          alert('é…ç½®ã•ã‚Œã¦ã„ã‚‹ã‚«ãƒ¼ãƒ‰ãŒã‚ã‚Šã¾ã›ã‚“');
        }
        return;
      }
      
      const confirmMessage = `${totalCards}æšã®é…ç½®ã•ã‚ŒãŸã‚«ãƒ¼ãƒ‰ã‚’ã™ã¹ã¦å‰Šé™¤ã—ã¾ã™ã€‚\nã“ã®æ“ä½œã¯å–ã‚Šæ¶ˆã›ã¾ã›ã‚“ã€‚\n\nå®Ÿè¡Œã—ã¾ã™ã‹ï¼Ÿ`;
      
      if (confirm(confirmMessage)) {
        // å…¨ãƒšãƒ¼ã‚¸ã®ã‚¹ãƒ­ãƒƒãƒˆã‚’åˆæœŸåŒ–
        binderState.pages.forEach(page => {
          const slotsPerPage = page.slots.length;
          page.slots = Array(slotsPerPage).fill(null);
        });
        
        saveBinder();
        renderBinder();
        
        if (isMobile) {
          showMobileAlert(`${totalCards}æšã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`, 'âœ…');
        } else {
          alert(`${totalCards}æšã®ã‚«ãƒ¼ãƒ‰ã‚’å‰Šé™¤ã—ã¾ã—ãŸ`);
        }
      }
    }

  </script>
</body>
</html>
