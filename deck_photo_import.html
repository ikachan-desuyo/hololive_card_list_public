<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ğŸ“¸ OCR ã‚«ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <script src="https://cdn.jsdelivr.net/npm/tesseract.js@4.0.2/dist/tesseract.min.js"></script>
  <style>
    body { font-family: sans-serif; padding: 16px; background: #f9f9f9; }
    h2 { margin-bottom: 12px; }
    .preview { margin-top: 16px; padding: 10px; background: #fff; box-shadow: 0 0 8px rgba(0,0,0,0.05); border: 1px solid #ccc; }
    .preview img { max-width: 100%; margin-bottom: 10px; border-radius: 4px; }
    .error { color: red; font-weight: bold; }
    #loading { margin-top: 8px; font-size: 14px; color: #666; }
  </style>
</head>
<body>
  <h2>ğŸ“¸ OCR ã‚«ãƒ¼ãƒ‰ã‚¹ã‚­ãƒ£ãƒ³</h2>
  <button onclick="history.back()">â† å‰ã®ãƒšãƒ¼ã‚¸ã¸</button>
  <!-- âœ… å†™çœŸãƒ©ã‚¤ãƒ–ãƒ©ãƒªã‹ã‚‰é¸æŠã§ãã‚‹ã‚ˆã†ã«å¤‰æ›´ -->
  <input type="file" accept="image/*" onchange="scanImageOCR(event)" />
  <div id="loading"></div>
  <div id="result" class="preview"></div>
  <input type="file" accept="image/*" onchange="scanImageAndColor(event)" />
  <div id="loading"></div>
  <div id="result" class="preview"></div>

  <script>
  let cardData = {};
  fetch('json_file/card_data.json')
    .then(res => res.json())
    .then(data => cardData = data);

  async function scanImageAndColor(event) {
    const file = event.target.files[0];
    if (!file) return;

    const loading = document.getElementById("loading");
    const result = document.getElementById("result");
    result.innerHTML = "";
    loading.textContent = "ğŸ” ç”»åƒè§£æä¸­â€¦";

    const imageURL = URL.createObjectURL(file);
    const img = new Image();
    img.src = imageURL;

    img.onload = async () => {
      // ğŸ”¤ OCRã§IDæŠ½å‡º
      let detectedId = null;
      try {
        const { data: { text } } = await Tesseract.recognize(imageURL, 'jpn');
        const match = text.match(/h[A-Z]{2,}[0-9]{3}-[0-9]{3}[_A-Z]*/);
        if (match) detectedId = match[0];
      } catch {}

      // ğŸ” OCRçµæœãŒä¸€è‡´ã™ã‚Œã°è¡¨ç¤º
      if (detectedId && cardData[detectedId]) {
        const card = cardData[detectedId];
        loading.textContent = "";
        showCardInfo(card);
        return;
      }

      // ğŸŒˆ è‰²åˆ†é¡å‡¦ç†ï¼ˆå¹³å‡è‰²æŠ½å‡ºï¼‰
      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");
      canvas.width = img.width;
      canvas.height = img.height;
      ctx.drawImage(img, 0, 0);
      const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height).data;

      let r = 0, g = 0, b = 0, count = 0;
      for (let i = 0; i < imageData.length; i += 4) {
        r += imageData[i]; g += imageData[i + 1]; b += imageData[i + 2]; count++;
      }
      r = Math.round(r / count); g = Math.round(g / count); b = Math.round(b / count);

      const avgColor = `rgb(${r}, ${g}, ${b})`;

      // ğŸ§  è‰²åˆ†é¡ã‹ã‚‰å€™è£œæŠ½å‡º
      const colorMap = {
        red: c => c.color === "èµ¤",
        yellow: c => c.color === "é»„",
        blue: c => c.color === "é’",
        white: c => c.color === "ç™½",
        purple: c => c.color === "ç´«"
      };

      let matchedColor = null;
      if (r > g && r > b) matchedColor = "red";
      else if (g > r && g > b) matchedColor = "green";
      else if (b > r && b > g) matchedColor = "blue";
      else if (r > 200 && g > 200) matchedColor = "yellow";
      else matchedColor = "white";

      const candidates = Object.values(cardData).filter(card => colorMap[matchedColor]?.(card));
      loading.textContent = "";

      result.innerHTML = `<p>ğŸ” OCRã§ã¯IDæ¤œå‡ºã§ãã¾ã›ã‚“ã§ã—ãŸ</p><p>ğŸ¨ è‰²åˆ¤å®šï¼š${avgColor} â†’ ${matchedColor}</p>`;
      result.innerHTML += `<h4>ğŸ” è‰²æ¨å®šã«ã‚ˆã‚‹å€™è£œã‚«ãƒ¼ãƒ‰ï¼ˆ${candidates.length}ä»¶ï¼‰</h4><ul>`;
      candidates.slice(0, 10).forEach(card => {
        result.innerHTML += `<li><strong>${card.name}</strong> - ${card.color || "?"}</li>`;
      });
      result.innerHTML += `</ul>`;
    };
  }

  function showCardInfo(card) {
    const result = document.getElementById("result");
    result.innerHTML = `
      <img src="${card.image_url}" alt="${card.name}" />
      <h3>${card.name}</h3>
      <p>ğŸ—‚ ${card.card_type}</p>
      ${(card.skills || []).map(skill => `
        <li><strong>${skill.type}</strong>ï¼š${skill.name ?? ""} ${skill.description ?? ""}</li>
      `).join("")}
    `;
  }
  </script>
</body>
</html>