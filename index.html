<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no" />
  <title>ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ç®¡ç†</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 10px;
      font-size: 15px;
      transition: background 0.3s, color 0.3s;
    }
    h2 {
      text-align: center;
      margin-bottom: 10px;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: auto;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 15px;
      word-wrap: break-word;
      white-space: normal;
      text-align: left;
    }
    th {
      background-color: #fff;
    }
    td.rarity, th.rarity {
      font-size: 13px;
      width: 40px;
      text-align: center;
    }
    td:nth-child(7) { min-width: 140px; } /* åéŒ²åˆ—ã‚’åºƒã‚ã« */
    .controls {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }
    select, input[type="text"], textarea, button {
      font-size: 1em;
      margin: 5px 0;
      max-width: 300px;
      padding: 6px;
      border-radius: 4px;
    }
    input[type="number"] { width: 60px; }
    img {
      width: 60px;
      border-radius: 4px;
      cursor: zoom-in;
    }
    tr[data-rarity="OSR"] { background-color: #ffe5f0; }
    tr[data-rarity="RR"]  { background-color: #e6f5ff; }
    tr[data-rarity="R"]   { background-color: #f9fff0; }
    tr[data-rarity="U"]   { background-color: #f3f3f3; }
    tr[data-rarity="C"]   { background-color: #fff; }
    .dark {
      background-color: #222;
      color: #eee;
    }
    .dark table, .dark th, .dark td { border-color: #666; }
    .dark input, .dark select, .dark button, .dark textarea {
      background-color: #333;
      color: #eee;
    }
    .dark th { background-color: #fff; }
    .dark #cardTable td, .dark #cardTable th { color: #111; }
    @media (max-width: 600px) {
      body { font-size: 16px; padding: 6px; }
      th, td { font-size: 14px; padding: 6px; }
      img { width: 45px; }
      input[type="number"] { width: 50px; }
    }
  </style>
</head>
<body>
  <h2>ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ä¸€è¦§</h2>
  <div class="controls">
    <button onclick="toggleDarkMode()">ğŸŒ— ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
    <input type="text" id="nameSearch" placeholder="ã‚«ãƒ¼ãƒ‰åæ¤œç´¢" oninput="renderTable()" />
    <select id="rarityFilter" onchange="renderTable()"></select>
    <select id="bloomFilter" onchange="renderTable()"></select>
    <select id="productFilter" onchange="renderTable()"></select>
    <label><input type="checkbox" id="ownedFilter" onchange="renderTable()"> æ‰€æŒã‚ã‚Šã®ã¿</label>
  </div>

  <div id="countDisplay" style="font-weight:bold; margin-bottom:10px;"></div>

  <table id="cardTable">
    <thead>
      <tr>
        <th>ç”»åƒ</th><th>ç•ªå·</th><th>åå‰</th><th class="rarity">ãƒ¬ã‚¢</th><th>Bloom</th><th>HP</th><th>åéŒ²</th><th>æšæ•°</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <h3>CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
  <div class="controls">
    <textarea id="csvInput" rows="4" placeholder="id,æšæ•° ã®CSVã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
    <button onclick="importCSV()">ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
    <button onclick="exportCSV()">ğŸ“¤ æ‰€æŒCSVã‚’ã‚³ãƒ”ãƒ¼</button>
  </div>
  <script>
    let cards = [];

    function setupFilters() {
      const raritySet = new Set(), bloomSet = new Set(), productSet = new Set();
      cards.forEach(c => {
        raritySet.add(c.rarity);
        bloomSet.add(c.bloom);
        productSet.add(c.product);
      });

      function populate(id, items, label) {
        const select = document.getElementById(id);
        select.innerHTML = `<option value="">${label}</option>`;
        [...items].sort().forEach(val => {
          const opt = document.createElement("option");
          opt.value = val;
          opt.textContent = val;
          select.appendChild(opt);
        });
      }

      populate("rarityFilter", raritySet, "ãƒ¬ã‚¢ãƒªãƒ†ã‚£");
      populate("bloomFilter", bloomSet, "Bloom");
      populate("productFilter", productSet, "åéŒ²å•†å“");
    }

    function renderTable() {
      const keyword = document.getElementById("nameSearch").value.toLowerCase();
      const rarity = document.getElementById("rarityFilter").value;
      const bloom = document.getElementById("bloomFilter").value;
      const product = document.getElementById("productFilter").value.toLowerCase();
      const ownedOnly = document.getElementById("ownedFilter").checked;

      const tbody = document.querySelector("#cardTable tbody");
      tbody.innerHTML = "";
      let shown = 0, ownedCount = 0;

      cards.forEach(card => {
        const count = card.owned;
        if (keyword && !card.name.toLowerCase().includes(keyword)) return;
        if (rarity && card.rarity !== rarity) return;
        if (bloom && card.bloom !== bloom) return;
        if (product && !card.product.toLowerCase().includes(product)) return;
        if (ownedOnly && (!count || count === 0)) return;

        shown++; ownedCount += parseInt(count || 0);

        const row = document.createElement("tr");
        row.setAttribute("data-rarity", card.rarity);
        row.innerHTML = `
          <td><img src="${card.image}" alt="${card.name}" onclick="showImageModal('${card.image}')"></td>
          <td>${card.id}</td>
          <td>${card.name}</td>
          <td class="rarity">${card.rarity}</td>
          <td>${card.bloom}</td>
          <td>${card.hp}</td>
          <td>${card.product}</td>
          <td><input type="number" min="0" value="${count}" onchange="updateOwned('${card.id}', this.value)"></td>
        `;
        tbody.appendChild(row);
      });

      updateCountDisplay(shown, ownedCount);
    }

    function updateOwned(id, value) {
      const num = Math.max(0, parseInt(value) || 0);
      localStorage.setItem("count_" + id, JSON.stringify(num));
      const card = cards.find(c => c.id === id);
      if (card) card.owned = num;
      renderTable();
    }

    function updateCountDisplay(total, owned) {
      const percent = total > 0 ? Math.round((owned / total) * 100) : 0;
      document.getElementById("countDisplay").textContent =
        `æ‰€æŒæšæ•°ï¼š${owned} / è¡¨ç¤ºï¼š${total}ï¼ˆå¹³å‡ ${percent}%ï¼‰`;
    }

    function toggleDarkMode() {
      document.body.classList.toggle("dark");
      localStorage.setItem("darkMode", document.body.classList.contains("dark"));
    }

    function importCSV() {
      const input = document.getElementById("csvInput").value.trim().split("\n");
      input.forEach(line => {
        const [id, count] = line.split(",");
        const num = Math.max(0, parseInt(count) || 0);
        localStorage.setItem("count_" + id, JSON.stringify(num));
        const card = cards.find(c => c.id === id);
        if (card) card.owned = num;
      });
      renderTable();
      alert("CSVã‚’åæ˜ ã—ã¾ã—ãŸï¼");
    }

    function exportCSV() {
      const lines = cards
        .filter(c => c.owned > 0)
        .map(c => `${c.id},${c.owned}`);
      const csv = lines.join("\n");
      navigator.clipboard.writeText(csv)
        .then(() => alert("æ‰€æŒCSVã‚’ã‚¯ãƒªãƒƒãƒ—ãƒœãƒ¼ãƒ‰ã«ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼"))
        .catch(() => alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ"));
    }

    function showImageModal(src) {
      const modal = document.getElementById("imageModal");
      modal.querySelector("img").src = src;
      modal.style.display = "block";
    }

    function hideImageModal() {
      document.getElementById("imageModal").style.display = "none";
    }

    window.onload = () => {
      if (localStorage.getItem("darkMode") === "true") {
        document.body.classList.add("dark");
      }

      fetch("json_file/card_data.json")
        .then(response => response.json())
        .then(rawData => {
          cards = Object.entries(rawData).map(([key, card]) => ({
            id: key,
            name: card.name,
            rarity: card.rarity,
            bloom: card.bloom_level ?? "-",
            hp: card.card_type === "ãƒ›ãƒ­ãƒ¡ãƒ³" ? card.hp : "-",
            product: card.product,
            image: card.image_url,
            url: `https://hololive-official-cardgame.com/cardlist/?id=${card.id}`,
            owned: parseInt(localStorage.getItem("count_" + card.id) ?? "0")
          }));
          setupFilters();
          renderTable();
        })
        .catch(() => alert("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸ"));
    };
  </script>
  <div id="imageModal" onclick="hideImageModal()" style="
  display:none;
  position:fixed;
  top:0; left:0;
  width:100%; height:100%;
  background:rgba(0,0,0,0.8);
  text-align:center;
  z-index:1000;
  cursor:zoom-out;
">
  <img src="" style="margin-top:50px; max-width:90%; max-height:90%;">
</div>
</body>
</html>
