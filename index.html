<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ç®¡ç†</title>
  <style>
    body {
      font-family: sans-serif;
      margin: 0;
      font-size: 15px;
      transition: background 0.3s, color 0.3s;
      overflow-x: hidden;
    }
    .container {
      max-width: none;
      width: fit-content;
      margin: 0 auto;
      padding: 10px;
    }
    .container-top {
      position: sticky;
      top: 0;
      background: #fff;
      z-index: 100;
      border-bottom: 1px solid #ccc;
    }
    h2 {
      text-align: center;
      margin-bottom: 10px;
      position: relative;
    }
    .top-nav {
      position: absolute;
      top: 0;
      right: 10px;
    }
    .top-nav button {
      padding: 6px 10px;
      font-size: 13px;
      cursor: pointer;
      border-radius: 6px;
    }
    .controls, .filter-row {
      display: flex;
      flex-wrap: wrap;
      gap: 10px;
      margin-bottom: 10px;
      align-items: center;
    }
    .filter-row label {
      display: flex;
      align-items: center;
      gap: 4px;
    }
    .filter-row button {
      padding: 4px 8px;
      font-size: 13px;
      cursor: pointer;
    }
    select {
      font-size: 15px;
      padding: 6px;
      max-width: 240px;
    }
    .filter-group {
      border: 1px solid #ccc;
      border-radius: 6px;
      padding: 10px;
      margin-bottom: 10px;
    }
    .filter-group legend {
      font-weight: bold;
      padding: 0 6px;
    }
    #filtersWrapper {
      transition: all 0.3s ease;
    }
    .sticky-info {
      background: #fff;
      padding: 10px 0;
      border-bottom: 1px solid #ccc;
    }
    table {
      border-collapse: collapse;
      width: 100%;
      table-layout: auto;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      font-size: 15px;
      text-align: left;
    }
    td:nth-child(2), th:nth-child(2) {
      white-space: nowrap;
      min-width: 100px;
    }
    td:nth-child(8), th:nth-child(8) {
      word-break: break-word;
      min-width: 120px;
    }
    @media screen and (max-width: 600px) {
      td:nth-child(2), th:nth-child(2) {
        min-width: 80px;
      }
      td:nth-child(8), th:nth-child(8) {
        min-width: 100px;
      }
    }
    td:nth-child(3), td.rarity { white-space: nowrap; }
    td.rarity, th.rarity { font-size: 13px; width: 40px; text-align: center; }
    input[type="number"] {
      width: 40px;
      background-color: #fff !important;
      color: #000;
      border: 1px solid #ccc;
    }
    img {
      width: 60px;
      border-radius: 4px;
      cursor: zoom-in;
      background-color: #fff;
      border: 1px solid #ddd;
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="container-top">
      <h2>
        ãƒ›ãƒ­ãƒ©ã‚¤ãƒ–ã‚«ãƒ¼ãƒ‰ä¸€è¦§
        <div class="top-nav">
          <button onclick="location.href='holoca_skill_page.html'">ğŸ“‚ ä»–ã®ãƒšãƒ¼ã‚¸ã¸</button>
        </div>
      </h2>

      <div class="controls">
        <button onclick="toggleDarkMode()">ğŸŒ— ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿</button>
        <input type="text" id="nameSearch" placeholder="ã‚«ãƒ¼ãƒ‰åæ¤œç´¢" oninput="renderTable()" />
      </div>

      <div class="controls">
        <button onclick="toggleFilters()">ğŸ”½ ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼è¡¨ç¤ºï¼éè¡¨ç¤º</button>
      </div>

      <div id="filtersWrapper">
        <fieldset class="filter-group">
          <legend>æ‰€æŒçŠ¶æ…‹</legend>
          <div class="filter-row" id="ownedStateGroup">
            <label><input type="checkbox" name="ownedState" value="owned" checked onchange="renderTable()"> æ‰€æŒã‚ã‚Š</label>
            <label><input type="checkbox" name="ownedState" value="unowned" checked onchange="renderTable()"> æ‰€æŒãªã—</label>
          </div>
        </fieldset>

        <fieldset class="filter-group">
          <legend>ãƒ¬ã‚¢ãƒªãƒ†ã‚£</legend>
          <button onclick="selectAll('rarityFilter')">å…¨é¸æŠ</button>
          <button onclick="clearAll('rarityFilter')">å…¨éƒ¨å¤–ã™</button>
          <div class="filter-row" id="rarityFilter"></div>
        </fieldset>

        <fieldset class="filter-group">
          <legend>è‰²</legend>
          <button onclick="selectAll('colorFilter')">å…¨é¸æŠ</button>
          <button onclick="clearAll('colorFilter')">å…¨éƒ¨å¤–ã™</button>
          <div class="filter-row" id="colorFilter"></div>
        </fieldset>

        <fieldset class="filter-group">
          <legend>Bloom</legend>
          <button onclick="selectAll('bloomFilter')">å…¨é¸æŠ</button>
          <button onclick="clearAll('bloomFilter')">å…¨éƒ¨å¤–ã™</button>
          <div class="filter-row" id="bloomFilter"></div>
        </fieldset>

        <fieldset class="filter-group">
          <legend>åéŒ²å•†å“</legend>
          <select id="productFilter" onchange="renderTable()">
            <option value="">åéŒ²å•†å“ï¼ˆé¸æŠï¼‰</option>
          </select>
        </fieldset>
      </div>
    </div>

    <div class="sticky-info">
      <div id="countDisplay" style="font-weight:bold;"></div>
      <div id="typeDisplay" style="font-weight:bold;"></div>
    </div>

    <table id="cardTable">
      <thead>
        <tr>
          <th>ç”»åƒ</th>
          <th>åå‰</th>
          <th>ç•ªå·</th>
          <th class="rarity">ãƒ¬ã‚¢</th>
          <th>è‰²</th>
          <th>Bloom</th>
          <th>HP</th>
          <th>åéŒ²</th>
          <th>æšæ•°</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>

    <h3>CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆãƒ»ã‚¨ã‚¯ã‚¹ãƒãƒ¼ãƒˆ</h3>
    <div class="controls">
      <textarea id="csvInput" rows="4" placeholder="id,æšæ•° ã®CSVã‚’è²¼ã‚Šä»˜ã‘ã¦ãã ã•ã„"></textarea>
      <button onclick="importCSV()">ğŸ“¥ CSVã‚¤ãƒ³ãƒãƒ¼ãƒˆ</button>
      <button onclick="exportCSV()">ğŸ“¤ æ‰€æŒCSVã‚’ã‚³ãƒ”ãƒ¼</button>
    </div>
    <div id="imageModal" onclick="hideImageModal()" style="
      display:none;
      position:fixed;
      top:0; left:0;
      width:100vw; height:100vh;
      background:rgba(0,0,0,0.8);
      text-align:center;
      z-index:1000;
      cursor:zoom-out;">
      <img src="" style="margin-top:5vh; width:100vw; max-height:90vh; object-fit:contain;">
    </div>

    <script>
      let cards = [];

      function selectAll(id) {
        document.querySelectorAll(`#${id} input[type="checkbox"]`).forEach(cb => cb.checked = true);
        renderTable();
      }

      function clearAll(id) {
        document.querySelectorAll(`#${id} input[type="checkbox"]`).forEach(cb => cb.checked = false);
        renderTable();
      }

      function toggleFilters() {
        const el = document.getElementById("filtersWrapper");
        el.style.display = el.style.display === "none" ? "block" : "none";
      }

      function setupFilters() {
        const raritySet = new Set(), colorSet = new Set(), bloomSet = new Set(), productSet = new Set();
        cards.forEach(c => {
          raritySet.add(c.rarity);
          colorSet.add(c.color);
          bloomSet.add(c.bloom);
          productSet.add(c.product);
        });

        function populateCheck(id, items) {
          const container = document.getElementById(id);
          items.forEach(val => {
            const label = document.createElement("label");
            label.innerHTML = `<input type="checkbox" value="${val}" checked onchange="renderTable()"> ${val}`;
            container.appendChild(label);
          });
        }

        function populateSelect(id, items, label) {
          const select = document.getElementById(id);
          select.innerHTML = `<option value="">${label}</option>`;
          [...items].sort().forEach(val => {
            const opt = document.createElement("option");
            opt.value = val;
            opt.textContent = val;
            select.appendChild(opt);
          });
        }

        populateCheck("rarityFilter", [...raritySet].sort());
        populateCheck("colorFilter", [...colorSet].sort());
        populateCheck("bloomFilter", [...bloomSet].sort());
        populateSelect("productFilter", productSet, "åéŒ²å•†å“");
      }

      function renderTable() {
        const keyword = document.getElementById("nameSearch").value.toLowerCase();
        const getChecked = id => [...document.querySelectorAll(`#${id} input:checked`)].map(el => el.value);

        const rarity = getChecked("rarityFilter");
        const color = getChecked("colorFilter");
        const bloom = getChecked("bloomFilter");
        const product = document.getElementById("productFilter").value.toLowerCase();
        const ownedStates = [...document.querySelectorAll('input[name="ownedState"]:checked')].map(el => el.value);

        const tbody = document.querySelector("#cardTable tbody");
        tbody.innerHTML = "";
        let shown = 0, ownedCount = 0, ownedTypes = 0;

        cards.forEach(card => {
          const count = card.owned;

          const matchOwned =
            ownedStates.length === 0 ||
            (ownedStates.includes("owned") && count > 0) ||
            (ownedStates.includes("unowned") && (!count || count == 0));
          if (!matchOwned) return;

          const match = {
            name: !keyword || card.name.toLowerCase().includes(keyword),
            rarity: rarity.length === 0 || rarity.includes(card.rarity),
            color: color.length === 0 || color.includes(card.color),
            bloom: bloom.length === 0 || bloom.includes(card.bloom),
            product: !product || card.product.toLowerCase().includes(product)
          };

          if (Object.values(match).includes(false)) return;

          shown++;
          if (card.owned > 0) ownedTypes++;
          ownedCount += parseInt(count || 0);

          const row = document.createElement("tr");
          row.setAttribute("data-rarity", card.rarity);
          row.innerHTML = `
            <td><img src="${card.image}" alt="${card.name}" onclick="showImageModal('${card.image}')"></td>
            <td>${card.name}</td>
            <td>${card.id}</td>
            <td class="rarity">${card.rarity}</td>
            <td>${card.color}</td>
            <td>${card.bloom}</td>
            <td>${card.hp}</td>
            <td>${card.product}</td>
            <td><input type="number" min="0" value="${count}" onchange="updateOwned('${card.id}', this.value)"></td>
          `;
          tbody.appendChild(row);
        });

        const ratio = shown > 0 ? Math.round((ownedTypes / shown) * 100) : 0;
        document.getElementById("countDisplay").textContent =
          `æ‰€æŒæšæ•°ï¼š${ownedCount} / è¡¨ç¤ºï¼š${shown}ç¨®é¡ï¼ˆæ‰€æŒç‡ ${ratio}%ï¼‰`;
        document.getElementById("typeDisplay").textContent =
          `æ‰€æŒç¨®é¡æ•°ï¼š${ownedTypes}`;
      }

      function updateOwned(id, value) {
        const num = Math.max(0, parseInt(value) || 0);
        localStorage.setItem("count_" + id, JSON.stringify(num));
        const card = cards.find(c => c.id === id);
        if (card) card.owned = num;
        renderTable();
      }

      function toggleDarkMode() {
        document.body.classList.toggle("dark");
        localStorage.setItem("darkMode", document.body.classList.contains("dark"));
      }

      function importCSV() {
        const input = document.getElementById("csvInput").value.trim().split("\n");
        input.forEach(line => {
          const [id, count] = line.split(",");
          const num = Math.max(0, parseInt(count) || 0);
          localStorage.setItem("count_" + id, JSON.stringify(num));
          const card = cards.find(c => c.id === id);
          if (card) card.owned = num;
        });
        renderTable();
        alert("CSVã‚’åæ˜ ã—ã¾ã—ãŸï¼");
      }

      function exportCSV() {
        const lines = cards.filter(c => c.owned > 0).map(c => `${c.id},${c.owned}`);
        navigator.clipboard.writeText(lines.join("\n"))
          .then(() => alert("æ‰€æŒCSVã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸ"))
          .catch(() => alert("ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ"));
      }

      function showImageModal(src) {
        const modal = document.getElementById("imageModal");
        modal.querySelector("img").src = src;
        modal.style.display = "block";
      }

      function hideImageModal() {
        document.getElementById("imageModal").style.display = "none";
      }

      window.onload = () => {
        if (localStorage.getItem("darkMode") === "true") {
          document.body.classList.add("dark");
        }

        fetch("json_file/card_data.json")
          .then(response => {
            if (!response.ok) throw new Error("JSONèª­ã¿è¾¼ã¿å¤±æ•—");
            return response.json();
          })
          .then(rawData => {
            cards = Object.entries(rawData)
              .sort(([idA], [idB]) => idA.localeCompare(idB))
              .map(([key, card]) => ({
                id: key,
                name: card.name,
                rarity: card.rarity ?? "-",
                color: card.color ?? "-",
                bloom: card.bloom_level ?? "-",
                hp: card.card_type === "ãƒ›ãƒ­ãƒ¡ãƒ³" ? card.hp : "-",
                product: card.product,
                image: card.image_url,
                url: `https://hololive-official-cardgame.com/cardlist/?id=${card.id}`,
                owned: parseInt(localStorage.getItem("count_" + card.id) ?? "0")
              }));
            setupFilters();
            renderTable();
          })
          .catch(err => {
            console.error(err);
            alert("JSONãƒ•ã‚¡ã‚¤ãƒ«ã®èª­ã¿è¾¼ã¿ã«å¤±æ•—ã—ã¾ã—ãŸï¼");
          });
      };
    </script>
  </div>
</body>
</html>
